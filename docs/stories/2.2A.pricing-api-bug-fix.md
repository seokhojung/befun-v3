# Story 2.2A: Pricing API 단위 변환 및 에러 처리 버그 수정

## Status

In Review

## Story

**As a** 개발자,
**I want** Pricing API의 단위 변환 누락과 에러 처리 버그를 수정,
**So that** 3D 컨피규레이터에서 정확한 가격이 계산되고 안정적인 에러 처리가 가능합니다.

## Story Context

이 스토리는 Story 1.2C QA 검증 중 발견된 Pricing API 버그를 수정하는 스토리입니다. Story 2.2 (실시간 가격 계산 시스템)는 이미 Done 상태이지만, 실제 사용 중 다음 버그들이 발견되었습니다:

**발견된 버그 (QA 분석):**

1. **단위 변환 누락**: ConfiguratorUI에서 미터(m) 단위를 cm로 변환하지 않고 API 호출
2. **에러 처리 버그**: Zod validation 에러 시 `error.errors`가 undefined인 경우 처리 안 됨

**서버 로그 증거:**

```
[2025-10-02T06:39:10.299Z] WARN Request validation failed { errors: undefined }
API Error: TypeError: Cannot read properties of undefined (reading 'map')
POST /api/v1/pricing/calculate 500 (Internal Server Error)
```

## Acceptance Criteria

1. ConfiguratorUI에서 Pricing API 호출 시 미터(m) 단위가 센티미터(cm)로 올바르게 변환되어야 함
2. POST `/api/v1/pricing/calculate`가 올바른 가격을 반환해야 함
3. API validation 에러 시 500이 아닌 400 Bad Request를 반환해야 함
4. `error.errors`가 undefined인 경우에도 안전하게 처리되어야 함(단일/배치 모든 경로 포함)
5. 브라우저 콘솔에 Pricing API 관련 에러가 없어야 함
6. 모든 6종 재료 (wood, mdf, steel, metal, glass, fabric)에 대해 정상 작동해야 함
7. API 응답 시간이 500ms 이내여야 함 (Story 2.2 AC 준수)
8. 배치 요청(calculations 배열 포함)에서 validation 에러 발생 시 400 Bad Request를 반환하고 안전한 에러 메시지(fallback)를 제공해야 함

## Tasks / Subtasks

- [ ] **Task 1: 단위 변환 버그 수정** (AC: 1, 2, 6)
  - [ ] ConfiguratorUI.tsx의 calculatePrice 호출 부분 확인
  - [ ] 미터 → 센티미터 변환 로직 추가 (\* 100)
  - [ ] handleSettingsChange 내부 calculatePriceRef.current 호출 수정
  - [ ] 초기 가격 계산 useEffect 내부 호출 수정

- [ ] **Task 2: API 에러 처리 버그 수정** (AC: 3, 4)
  - [ ] route.ts의 에러 처리 로직 개선
  - [ ] error.errors undefined 체크 추가 (optional chaining)
  - [ ] 적절한 에러 메시지 fallback 구현
  - [ ] HTTP 상태 코드 올바르게 설정 (400 vs 500)
  - [ ] 배치 처리 경로(ZodError) 동일 수정 (약 349–356행)

- [ ] **Task 3: 단위 테스트 작성** (AC: 1, 2, 3, 4)
  - [ ] 단위 변환 로직 테스트 케이스 작성
  - [ ] 에러 처리 로직 테스트 케이스 작성
  - [ ] 각 재료별 가격 계산 테스트
  - [ ] 배치 검증 에러(계산 리스트 포함) 400 + `error.errors` undefined 방어 테스트 추가

- [ ] **Task 4: 통합 테스트 및 검증** (AC: 1-7)
  - [ ] 브라우저에서 /configurator 페이지 테스트
  - [ ] 6종 재료 각각에 대한 가격 계산 확인
  - [ ] 네트워크 탭에서 API 응답 확인
  - [ ] 콘솔 에러 확인

- [ ] **Task 5: 성능 최적화 확인** (AC: 7)
  - [ ] API 응답 시간 측정
  - [ ] 캐싱 전략 동작 확인
  - [ ] 디바운싱 로직 확인

## Dev Notes

### 기술 스택 정보

[Source: architecture/tech-stack-안정-버전-확정.md]

- **Backend Runtime**: Node.js v20.x (LTS)
- **Language**: TypeScript 5.3.x (strict mode)
- **Database**: Supabase PostgreSQL 15
- **API Style**: REST API (OpenAPI 3.0)

### 현재 파일 구조

- `/src/app/configurator/components/ConfiguratorUI.tsx` - 컨피규레이터 UI (버그 위치)
- `/src/app/api/v1/pricing/calculate/route.ts` - Pricing API 엔드포인트 (에러 처리 버그)
- `/src/lib/pricing/index.ts` - PricingAPI 유틸리티
- `/src/lib/pricing/calculator.ts` - 가격 계산 로직
- `/src/hooks/use-pricing.ts` - 가격 계산 React Hook

### 버그 수정 위치 및 방법

#### 1. 단위 변환 버그 수정 (ConfiguratorUI.tsx)

**현재 코드 (버그):**

```typescript
// Line 177-184
calculatePriceRef.current({
  width_cm: settings.dimensions.width, // ❌ 1.2m을 1.2cm로 전달
  depth_cm: settings.dimensions.depth, // ❌ 0.6m을 0.6cm로 전달
  height_cm: settings.dimensions.height, // ❌ 0.75m을 0.75cm로 전달
  material: currentMaterial.properties.type as MaterialType,
  use_cache: true,
  estimate_only: false,
})
```

**수정해야 할 코드:**

```typescript
calculatePriceRef.current({
  width_cm: settings.dimensions.width * 100, // ✅ m → cm 변환
  depth_cm: settings.dimensions.depth * 100, // ✅ m → cm 변환
  height_cm: settings.dimensions.height * 100, // ✅ m → cm 변환
  material: currentMaterial.properties.type as MaterialType,
  use_cache: true,
  estimate_only: false,
})
```

**참고:** handleSettingsChange 내부에도 같은 수정 필요 (Line 219-225 추정)

#### 2. 에러 처리 버그 수정 (route.ts)

**현재 코드 (버그):**

```typescript
// Line 220-228
if (error instanceof z.ZodError) {
  logger.warn('Request validation failed', requestId, {
    errors: error.errors,
  })
  timer.complete(400)
  return createErrorResponse(
    new Error(`유효하지 않은 요청: ${error.errors.map(e => e.message).join(', ')}`), // ❌ error.errors가 undefined면 에러
    requestId
  )
}
```

**수정해야 할 코드:**

```typescript
if (error instanceof z.ZodError) {
  logger.warn('Request validation failed', requestId, {
    errors: error.errors,
  })
  timer.complete(400)

  // ✅ Optional chaining과 fallback 메시지
  const errorMessage = error.errors?.map(e => e.message).join(', ') || 'Validation failed'
  return createErrorResponse(new Error(`유효하지 않은 요청: ${errorMessage}`), requestId)
}
```

**배치 처리 경로도 동일하게 수정 필요:**

```typescript
// Batch ZodError 처리
if (error instanceof z.ZodError) {
  logger.warn('Batch request validation failed', requestId, {
    errors: error.errors,
  })
  timer.complete(400)

  const errorMessage = error.errors?.map(e => e.message).join(', ') || 'Validation failed'
  return createErrorResponse(new Error(`유효하지 않은 요청: ${errorMessage}`), requestId)
}
```

### 가격 계산 로직 정보

[Source: Story 2.2 구현]

**재료별 가격 배수:**

- wood: 1.0
- mdf: 0.8
- steel: 1.15
- metal: 1.5
- glass: 2.0
- fabric: 0.8

**계산 공식:**

```
총가격 = (width_cm × depth_cm × height_cm) / 1000000 × 재료_배수 × 기본_단가
```

### API 스키마

[Source: src/app/api/v1/pricing/calculate/route.ts]

**Request Schema:**

```typescript
{
  width_cm: number (1-1000),
  depth_cm: number (1-1000),
  height_cm: number (1-300),
  material: 'wood' | 'mdf' | 'steel' | 'metal' | 'glass' | 'fabric',
  options?: Record<string, any>,
  use_cache?: boolean (default: true),
  estimate_only?: boolean (default: false)
}
```

### Testing Standards

- **Test Location**: `__tests__/api/pricing/` 디렉토리
- **Unit Tests**: Jest
- **Integration Tests**: Supertest 또는 fetch API
- **Performance Tests**: API 응답 시간 측정
  - 배치 검증 에러(400) 및 `error.errors` undefined 안전 처리 테스트 포함

### 중요 제약사항

1. **Story 2.2 호환성**: 기존 가격 계산 시스템과 완벽히 호환되어야 함
2. **6종 재료 지원**: 모든 재료에 대해 정상 작동 확인
3. **성능 요구사항**: 500ms 이내 응답
4. **TypeScript strict mode** 준수

## Change Log

| Date       | Version | Description                                  | Author   |
| :--------- | :------ | :------------------------------------------- | :------- |
| 2025-10-02 | 1.0     | Initial story creation from 1.2C QA findings | Bob (SM) |

## Dev Agent Record

### Agent Model Used

Codex CLI Dev Agent (OpenAI) – Node v20 / TS 5.3

### Debug Log References

- 00console-error-log.txt: PurchaseFlow null 참조 런타임 오류 재현 및 가드 추가 완료
- Jest 타깃 실행: `__tests__/api/v1/pricing/calculate.test.ts` (모킹/상태코드 불일치로 실패 확인)
- Type check: 전역 타입 오류 다수(스토리 범위 외) – 분리 이슈 권고

### Completion Notes List

- Configurator에서 가격 계산 요청의 m→cm 변환을 초기/설정변경/재시도 경로에 모두 적용
- Pricing API 라우트에서 ZodError 처리 시 optional chaining 및 VALIDATION_FAILED 코드 반영, 배치 경로 동일 보강
- 테스트 환경 헤더 설정 시 호환 가드 추가(NextResponse.headers.set 안전 호출)
- PurchaseSection에 전달되는 cartData null 가드 추가로 런타임 오류 제거
- 테스트는 구현 의도(4xx)와 기존 기대(500) 불일치 – 테스트 정렬 작업 필요
 - usePricing 훅 onPriceChange 안정화: ref로 콜백 안정화 및 동일 total 반복 알림 무시(로그 폭주 방지)

### File List

- src/app/configurator/components/ConfiguratorUI.tsx
- src/app/api/v1/pricing/calculate/route.ts
- **tests**/api/v1/pricing/calculate.test.ts (모킹 정렬 보완)

### Dev Checklist (Brownfield)

- [x] 스토리 문서 상태/Dev Agent Record 업데이트
- [x] 변경 파일 목록 정리 및 커버 범위 명시
- [x] 콘솔 오류 재현/해결 로그 참조 추가
- [x] QA 게이트 연계(게이트 파일 생성 및 상태 연동)
- [ ] 테스트 정렬(VALIDATION_FAILED 4xx 기대) 및 배치 경로 검증 추가
- [ ] 브라우저 콘솔 무에러/6종 재료/<500ms 성능 검증

## QA Results

Gate Decision: CONCERNS

Summary (Re-verify)
- 컨피규레이터 정상 동작 상태에서 가격 훅(onPriceChange) 안정화로 로그 폭주 제거됨(동일 total 반복 알림 억제). UI 파생 이슈 해소.
- m→cm 변환 3 경로 반영 확인(초기/변경/재시도).
- Zod 검증 에러에서 안전 처리 유지. 검증 실패 시 400(BAD_REQUEST) 정렬 완료.
- 테스트 하네스는 여전히 500 기대/모킹 불일치로 미정렬 상태.

Acceptance Criteria Review (Update)

- AC1 m→cm 변환: PASS – 3 경로 모두 적용.
- AC2 단일 계산 정상 가격: CONCERNS – 통합 검증 필요(테스트 하네스 정렬 대기).
- AC3 검증 실패 시 400: PASS – BAD_REQUEST(400) 정렬 확인.
- AC4 error.errors undefined 방어: PASS – 단일/배치 적용.
- AC5 콘솔 에러 없음: PASS – 가격 로그 폭주 해소.
- AC6 6종 재료 정상 동작: CONCERNS – 전수 확인 필요.
- AC7 응답 < 500ms: CONCERNS – 측정 필요.
- AC8 배치 검증 에러 400 + 안전 메시지: CONCERNS – 배치 경로 통합 검증 필요.

Test Scenarios (Given-When-Then)

- Given 잘못된 width_cm(-100) When POST /api/v1/pricing/calculate Then 400 Bad Request 그리고 안전 메시지(Validation failed/fallback)
- Given calculations 배열 내 1개 이상 invalid When POST 배치 Then 400 Bad Request 그리고 각 invalid 요청 사유 포함(민감 정보 제외)
- Given width/depth/height=120/60/75, material=wood When POST Then 200 OK 그리고 합리적 total과 volume_m3 반환(성능 < 500ms)
- Given m 단위 UI 입력 When 가격 호출 Then cm로 변환되어 API 전송(120/60/75)

Risks

- 요구사항(400) vs 구현(422) 불일치 지속 시, 클라이언트와 모니터링/게이트웨이 규칙 혼선 가능.
- 테스트 인프라 모킹 불일치로 회귀 검출 신뢰도 저하.
- 성능/6재료/콘솔 무에러 미검증으로 출시 리스크 잔존.

Recommendations (Must-Fix for PASS)

- 테스트 하네스 정렬(Request/NextResponse 모킹 표준화, 400 기대), 배치 검증 실패 케이스 추가.
- 통합 검증: 6종 재료 정상 동작 및 <500ms 응답 시간 측정.
- 로깅: 검증 실패 메시지 비민감 유지.

Evidence

- 코드: `src/app/configurator/components/ConfiguratorUI.tsx`(m→cm, cartData null 가드), `src/app/api/v1/pricing/calculate/route.ts`(optional chaining, 검증 실패 응답 경로)
- 로그: `00console-error-log.txt` – cartData null 참조 오류 → 가드 후 재검증 필요
- 테스트: `__tests__/api/v1/pricing/calculate.test.ts` – 모킹/상태코드 불일치로 다수 실패

Gate: CONCERNS – AC3/AC8 상태코드, AC5/AC6/AC7 미검증을 해소 후 재평가 권고.
