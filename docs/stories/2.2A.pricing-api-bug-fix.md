# Story 2.2A: Pricing API 단위 변환 및 에러 처리 버그 수정

## Status

Draft

## Story

**As a** 개발자,
**I want** Pricing API의 단위 변환 누락과 에러 처리 버그를 수정,
**So that** 3D 컨피규레이터에서 정확한 가격이 계산되고 안정적인 에러 처리가 가능합니다.

## Story Context

이 스토리는 Story 1.2C QA 검증 중 발견된 Pricing API 버그를 수정하는 스토리입니다. Story 2.2 (실시간 가격 계산 시스템)는 이미 Done 상태이지만, 실제 사용 중 다음 버그들이 발견되었습니다:

**발견된 버그 (QA 분석):**
1. **단위 변환 누락**: ConfiguratorUI에서 미터(m) 단위를 cm로 변환하지 않고 API 호출
2. **에러 처리 버그**: Zod validation 에러 시 `error.errors`가 undefined인 경우 처리 안 됨

**서버 로그 증거:**
```
[2025-10-02T06:39:10.299Z] WARN Request validation failed { errors: undefined }
API Error: TypeError: Cannot read properties of undefined (reading 'map')
POST /api/v1/pricing/calculate 500 (Internal Server Error)
```

## Acceptance Criteria

1. ConfiguratorUI에서 Pricing API 호출 시 미터(m) 단위가 센티미터(cm)로 올바르게 변환되어야 함
2. POST `/api/v1/pricing/calculate`가 올바른 가격을 반환해야 함
3. API validation 에러 시 500이 아닌 400 Bad Request를 반환해야 함
4. `error.errors`가 undefined인 경우에도 안전하게 처리되어야 함
5. 브라우저 콘솔에 Pricing API 관련 에러가 없어야 함
6. 모든 6종 재료 (wood, mdf, steel, metal, glass, fabric)에 대해 정상 작동해야 함
7. API 응답 시간이 500ms 이내여야 함 (Story 2.2 AC 준수)

## Tasks / Subtasks

- [ ] **Task 1: 단위 변환 버그 수정** (AC: 1, 2, 6)
  - [ ] ConfiguratorUI.tsx의 calculatePrice 호출 부분 확인
  - [ ] 미터 → 센티미터 변환 로직 추가 (* 100)
  - [ ] handleSettingsChange 내부 calculatePriceRef.current 호출 수정
  - [ ] 초기 가격 계산 useEffect 내부 호출 수정

- [ ] **Task 2: API 에러 처리 버그 수정** (AC: 3, 4)
  - [ ] route.ts의 에러 처리 로직 개선
  - [ ] error.errors undefined 체크 추가 (optional chaining)
  - [ ] 적절한 에러 메시지 fallback 구현
  - [ ] HTTP 상태 코드 올바르게 설정 (400 vs 500)

- [ ] **Task 3: 단위 테스트 작성** (AC: 1, 2, 3, 4)
  - [ ] 단위 변환 로직 테스트 케이스 작성
  - [ ] 에러 처리 로직 테스트 케이스 작성
  - [ ] 각 재료별 가격 계산 테스트

- [ ] **Task 4: 통합 테스트 및 검증** (AC: 1-7)
  - [ ] 브라우저에서 /configurator 페이지 테스트
  - [ ] 6종 재료 각각에 대한 가격 계산 확인
  - [ ] 네트워크 탭에서 API 응답 확인
  - [ ] 콘솔 에러 확인

- [ ] **Task 5: 성능 최적화 확인** (AC: 7)
  - [ ] API 응답 시간 측정
  - [ ] 캐싱 전략 동작 확인
  - [ ] 디바운싱 로직 확인

## Dev Notes

### 기술 스택 정보
[Source: architecture/tech-stack-안정-버전-확정.md]
- **Backend Runtime**: Node.js v20.x (LTS)
- **Language**: TypeScript 5.3.x (strict mode)
- **Database**: Supabase PostgreSQL 15
- **API Style**: REST API (OpenAPI 3.0)

### 현재 파일 구조
- `/src/app/configurator/components/ConfiguratorUI.tsx` - 컨피규레이터 UI (버그 위치)
- `/src/app/api/v1/pricing/calculate/route.ts` - Pricing API 엔드포인트 (에러 처리 버그)
- `/src/lib/pricing/index.ts` - PricingAPI 유틸리티
- `/src/lib/pricing/calculator.ts` - 가격 계산 로직
- `/src/hooks/use-pricing.ts` - 가격 계산 React Hook

### 버그 수정 위치 및 방법

#### 1. 단위 변환 버그 수정 (ConfiguratorUI.tsx)

**현재 코드 (버그):**
```typescript
// Line 177-184
calculatePriceRef.current({
  width_cm: settings.dimensions.width,    // ❌ 1.2m을 1.2cm로 전달
  depth_cm: settings.dimensions.depth,     // ❌ 0.6m을 0.6cm로 전달
  height_cm: settings.dimensions.height,   // ❌ 0.75m을 0.75cm로 전달
  material: currentMaterial.properties.type as MaterialType,
  use_cache: true,
  estimate_only: false
})
```

**수정해야 할 코드:**
```typescript
calculatePriceRef.current({
  width_cm: settings.dimensions.width * 100,   // ✅ m → cm 변환
  depth_cm: settings.dimensions.depth * 100,   // ✅ m → cm 변환
  height_cm: settings.dimensions.height * 100, // ✅ m → cm 변환
  material: currentMaterial.properties.type as MaterialType,
  use_cache: true,
  estimate_only: false
})
```

**참고:** handleSettingsChange 내부에도 같은 수정 필요 (Line 219-225 추정)

#### 2. 에러 처리 버그 수정 (route.ts)

**현재 코드 (버그):**
```typescript
// Line 220-228
if (error instanceof z.ZodError) {
  logger.warn('Request validation failed', requestId, {
    errors: error.errors
  })
  timer.complete(400)
  return createErrorResponse(
    new Error(`유효하지 않은 요청: ${error.errors.map(e => e.message).join(', ')}`),  // ❌ error.errors가 undefined면 에러
    requestId
  )
}
```

**수정해야 할 코드:**
```typescript
if (error instanceof z.ZodError) {
  logger.warn('Request validation failed', requestId, {
    errors: error.errors
  })
  timer.complete(400)

  // ✅ Optional chaining과 fallback 메시지
  const errorMessage = error.errors?.map(e => e.message).join(', ') || 'Validation failed'
  return createErrorResponse(
    new Error(`유효하지 않은 요청: ${errorMessage}`),
    requestId
  )
}
```

### 가격 계산 로직 정보
[Source: Story 2.2 구현]

**재료별 가격 배수:**
- wood: 1.0
- mdf: 0.8
- steel: 1.15
- metal: 1.5
- glass: 2.0
- fabric: 0.8

**계산 공식:**
```
총가격 = (width_cm × depth_cm × height_cm) / 1000000 × 재료_배수 × 기본_단가
```

### API 스키마
[Source: src/app/api/v1/pricing/calculate/route.ts]

**Request Schema:**
```typescript
{
  width_cm: number (1-1000),
  depth_cm: number (1-1000),
  height_cm: number (1-300),
  material: 'wood' | 'mdf' | 'steel' | 'metal' | 'glass' | 'fabric',
  options?: Record<string, any>,
  use_cache?: boolean (default: true),
  estimate_only?: boolean (default: false)
}
```

### Testing Standards

- **Test Location**: `__tests__/api/pricing/` 디렉토리
- **Unit Tests**: Jest
- **Integration Tests**: Supertest 또는 fetch API
- **Performance Tests**: API 응답 시간 측정

### 중요 제약사항

1. **Story 2.2 호환성**: 기존 가격 계산 시스템과 완벽히 호환되어야 함
2. **6종 재료 지원**: 모든 재료에 대해 정상 작동 확인
3. **성능 요구사항**: 500ms 이내 응답
4. **TypeScript strict mode** 준수

## Change Log

| Date | Version | Description | Author |
|:-----|:--------|:------------|:-------|
| 2025-10-02 | 1.0 | Initial story creation from 1.2C QA findings | Bob (SM) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_