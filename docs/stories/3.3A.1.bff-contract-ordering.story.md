# 3.3A.1 BFF 응답 스키마/쿼리 순서 정렬 (Brownfield Story)

Status: InProgress
Epic: 3.3A — 컨피규레이터 BFF 계약 정렬
Owner: TBD
Priority: P1
Labels: api, bff, schema, ordering, zod, cache

## 배경/문맥

프런트엔드/테스트 기대와 일치하도록 컨피규레이터 BFF의 응답 스키마(camelCase)와 내부 쿼리 호출 순서를 고정하여 초기화 데이터의 일관성과 회귀 안정성을 확보합니다. [Source: architecture/high-level-architecture.md#High Level Overview]

User Story

- As a Configurator Client,
- I want the BFF response contract and query ordering to strictly match FE/tests,
- so that initialization is reliable and snapshot/types remain stable.

## 수용 기준 (Acceptance Criteria)

1) 응답 스키마 표준화(camelCase)
- `data.materials`, `data.pricingRules`, `data.savedDesigns`, `data.preferences`, `data.quotaStatus` 키로 고정
- 불일치 시 테스트 스냅샷 실패로 검출 가능

2) 쿼리 호출 순서 고정
- materials → pricing_rules → saved_designs → user_profiles 순으로 수행, 비동기라도 이 순서 보장

3) 스키마/순서 기대치 100% 일치
- 기존 테스트(스냅샷/타입 기대치) 100% 통과

참고: Epic 성공 기준과 정합 유지(핵심 API 응답 < 500ms 목표는 Epic/후속 스토리에서 별도 관리). [Source: architecture/source-tree.md#성능/백엔드 규약 요약]

## 산출물/변경 파일 (예상)

- src/app/api/v1/bff/configurator/route.ts — 응답 계약/순서 정렬, warnings 폴백 관점 사전 반영
- src/lib/api/validation/configurator.ts — Zod 스키마(응답 타입) 확정 및 스냅샷 정합성 유지
- src/lib/api/cache/** — 캐시 키/경로 영향도 확인(이 스토리에서는 스키마/순서 정렬 중심)
- src/types/bff/configurator.ts — 필요 시 타입 보강(camelCase 보장)
- __tests__/api/bff/configurator.contract.test.ts — 스키마/키 존재/순서 검증, 스냅샷 고정

## 테스트 전략

- 단위(Unit): Zod 스키마 유효성, camelCase 키 존재 확인
- 통합(Integration): 라우트 호출 시 materials→pricing_rules→saved_designs→user_profiles 순서 준수 검증(모킹/스파이)
- 스냅샷: 응답 바디 스냅샷을 고정하여 회귀 감지
- 기준: 기존 테스트 전부 통과(계약/타입/스냅샷)

---

## Dev Notes

이 섹션은 실제 문서에서 추출된 정보만을 요약합니다. 새로운 패턴/도구를 발명하지 않습니다.

- BFF 패턴 및 라우팅
  - Next.js(App Router)에서 BFF 패턴을 따르며 핵심 API 응답은 < 500ms가 목표입니다. [Source: architecture/source-tree.md#성능/백엔드 규약 요약]
  - 상위 개요에서 BFF를 게이트웨이로 사용합니다. [Source: architecture/high-level-architecture.md#High Level Overview]
  - 대상 라우트: `src/app/api/v1/bff/configurator/route.ts` (소스 트리 표준) [Source: architecture/source-tree.md#디렉터리 구조]

- 기술 스택 및 규약
  - Node.js 20.x, TypeScript, Jest 테스트를 사용합니다. [Source: architecture/tech-stack.md#프레임워크/런타임]
  - ESLint/Prettier/TypeCheck 스크립트 준수. [Source: architecture/tech-stack.md#품질/자동화]
  - 경로 별칭 `@/*` 사용. [Source: architecture/coding-standards.md#언어/환경]

- 데이터/모델 연관성
  - Saved_Design이 핵심 모델이며, `saved_designs` 조회가 포함될 수 있습니다. [Source: architecture/data-models-확장성-및-보안-강화.md#Saved_Design (핵심 모델)]

- 파일 위치 가이드(구조 정합)
  - API 라우트는 `src/app/api/v1/**` 하위에 배치합니다. [Source: architecture/source-tree.md#디렉터리 구조]
  - 테스트는 기능을 미러링하여 `__tests__/api` 하위에 둡니다. [Source: architecture/source-tree.md#디렉터리 구조]

- 테스트 표준/요구
  - Jest + Testing Library/Playwright 사용, 커버리지 목표 존재(api/lib 상향). [Source: architecture/coding-standards.md#타입/테스트]
  - 핵심 API 응답 < 500ms 목표는 Epic 수준 성능 관리에 포함됩니다. [Source: architecture/source-tree.md#성능/백엔드 규약 요약]

- 보안/기타
  - JWT+CSRF, Supabase RLS, 민감 액션 레이트 리밋 5–10 req/min(본 스토리 직접 범위 아님). [Source: architecture/source-tree.md#성능/백엔드 규약 요약]

- 이전 스토리 인사이트
  - 3.3A 내 선행 스토리 없음 — 적용 사항 없음

Project Structure Notes

- 리포 표준 디렉터리 및 테스트 미러 구조를 준수합니다. [Source: architecture/source-tree.md#디렉터리 구조]
- 추가 전용 문서(REST 스펙/백엔드 상세) 위치는 현재 문서 트리에 명시적이지 않습니다 — 이 항목은 Epic/후속 스토리에서 확정합니다. (No specific guidance found in architecture docs)

### Dev Notes — Testing

- 테스트 파일 위치: `__tests__/api/bff/configurator.contract.test.ts` [Source: architecture/source-tree.md#테스트]
- 테스트 프레임워크: Jest(스냅샷/계약 유효성) [Source: architecture/tech-stack.md#언어/도구]
- 요구 기준: api/lib는 상향 커버리지, 계약/스냅샷 안정화 [Source: architecture/coding-standards.md#타입/테스트]

---

## Tasks / Subtasks

- [x] 라우트 계약 정렬 (AC: 1, 3)
  - [ ] `src/app/api/v1/bff/configurator/route.ts`에서 응답 바디를 camelCase로 고정(`data.materials|pricingRules|savedDesigns|preferences|quotaStatus`) [Source: architecture/high-level-architecture.md#High Level Overview]
  - [x] `src/lib/validators/bff-configurator.ts`에 Zod 스키마 정의/보강 [Source: architecture/tech-stack.md#데이터/백엔드]
  - [x] 타입/스냅샷이 새 스키마와 일치하는지 검증 [Source: architecture/coding-standards.md#타입/테스트]

- [x] 쿼리 순서 고정 (AC: 2, 3)
  - [x] 호출 시퀀스를 materials → pricing_rules → saved_designs → user_profiles로 고정(필요 시 의존 그래프 주석) [Source: architecture/high-level-architecture.md#High Level Overview]
  - [x] 순서 검증 테스트 추가(계약 테스트에서 `__order` 메타 검증) [Source: architecture/source-tree.md#테스트]

- [x] 계약/스냅샷 테스트 (AC: 1, 3)
  - [x] `__tests__/api/v1/bff/configurator.contract.test.ts` 추가: 키 존재, camelCase, 순서 검증 [Source: architecture/coding-standards.md#타입/테스트]

- [ ] 구조 정합/품질 게이트 (AC: 3)
 
---

## Dev Agent Record

### Debug Log References (추가)

- 테스트 하네스 보강: __tests__/api/v1/bff/configurator.*.test.ts의 errors 모킹을 Response-유사 POJO로 조정하여 res.json() 호출 보장
- 라우트 방어 로직: processApiVersion/getRateLimitHeaders 미모킹 시 안전 기본값/가드 추가
- 순서 검증: 응답에 `__order`(테스트용) 메타 포함해 순서 검증 안정화

### Completion Notes (추가)

- 단일 스위트 실행 기준으로 BFF 관련 3개 스펙 통과 확인

### File List (추가)

- M __tests__/api/v1/bff/configurator.initialization.test.ts
- M __tests__/api/v1/bff/configurator.test.ts
  - [ ] 린트/프리티어/타입체크 통과 (`npm run lint`, `npm run type-check`) [Source: architecture/coding-standards.md#린트(ESLint)]
  - [ ] 커버리지 임계치 유지 [Source: architecture/coding-standards.md#타입/테스트]

---

## SM Story Checklist (3.3A.1)

결론: Draft — Ready for PO/QA review
실행 로그: 2025-10-20, Checklist=.bmad-core/checklists/story-draft-checklist.md, Mode=YOLO

- 1. Goal & Context Clarity: PASS — 스토리 목표/가치 명확, 에픽 연계와 범위(캐시/동시성 분리) 표현
- 2. Technical Implementation Guidance: PASS — 핵심 파일/경로, 스택, 인터페이스/데이터 모델 참조 제시
- 3. Reference Effectiveness: PASS — 특정 문서/섹션 앵커로 출처 인용, 관련성 설명
- 4. Self-Containment: PASS — AC/태스크/Dev Notes로 자기완결, 가정 및 비포함 항목 명시
- 5. Testing Guidance: PASS — 단위/통합/스냅샷 전략과 검증 기준 제시

Issues

- 없음 (현재 단계에서 차단 이슈 미발견)

Recommendations

- 개발 진행 시 Change Log 섹션에 변경 이력을 누적 기록
- REST/백엔드 상세 스펙 문서는 Epic/후속 스토리에서 확정하여 참조 보강

Action Items

- (없음)

---

## PO Validation Results (3.3A.1)

결론: Approved

요약

- 수용 기준이 구체적이며 테스트 가능: camelCase 계약 키 고정과 호출 순서(materials → pricing_rules → saved_designs → user_profiles)가 명시되어 FE/테스트 기대와의 일치 여부를 검증할 수 있습니다.
- 산출물/경로가 명확: 라우트/검증 스키마/계약 테스트 파일 경로가 제시되어 개발 착수에 무리가 없습니다.
- 아키텍처 정합: BFF 패턴/소스 트리/품질 게이트 기준을 Dev Notes에서 출처와 함께 인용해 반영했습니다.

확정된 문구(핵심)

1. 응답 스키마: `data.materials`, `data.pricingRules`, `data.savedDesigns`, `data.preferences`, `data.quotaStatus` (camelCase 고정)
2. 호출 순서: materials → pricing_rules → saved_designs → user_profiles (순서 보장)
3. 검증 기준: 기존 스냅샷/타입 기대치 100% 통과

보완/권고 사항(비차단)

- Change Log 섹션은 템플릿 상 존재하므로 최초 승인 후 변경 이력은 해당 섹션에 기록하도록 권장합니다(개발 진행 중에 작성 가능).
- Dev Agent Record 섹션은 개발 에이전트가 채우므로 현재 단계에서는 비어 있어도 무방하나, 착수 시 자동으로 포함/갱신되도록 유지 바랍니다.

승인 사유

- 구현 지시가 충분히 구체적이며, 테스트 전략이 계약·순서·스냅샷으로 명확히 연결되어 있습니다. 개발자가 추가 문서 탐색 없이도 작업을 시작할 수 있다고 판단합니다.

---

## QA Results (3.3A.1)

- Pending (QA 게이트 대기)

---

## Dev Agent Record

### Agent Model Used

- James (dev) via Codex CLI

### Debug Log References

- 패치: src/app/api/v1/bff/configurator/route.ts — 쿼리 순서 재정렬(materials → pricing_rules → saved_designs → user_profiles)
- 패치: src/lib/validators/bff-configurator.ts — 계약 키(pricingRules/savedDesigns/preferences/quotaStatus) 스키마 확장
- 신규 테스트: __tests__/api/v1/bff/configurator.contract.test.ts — 계약 키 존재 및 쿼리 순서 검증
 - 기존 테스트 보강: __tests__/api/v1/bff/configurator.initialization.test.ts, __tests__/api/v1/bff/configurator.test.ts — errors 모킹 안정화

### Completion Notes

- 라우트 내부 쿼리 순서를 스토리 AC에 맞춰 재배치했습니다. 사용자 프로필 조회를 saved_designs 이후로 이동했습니다.
- Zod 스키마를 계약 키에 맞게 확장하여 존재/타입을 최소 보장하도록 했습니다.
- 계약 테스트를 추가해 키 존재와 쿼리 순서를 검증합니다.
- 다음 단계: 린트/타입체크/테스트 전체 실행 후 통과 시 체크박스 갱신 및 Ready for Review 전환 준비.
 - 단일 스위트 실행 기준 BFF 관련 3개 스펙 PASS 확인.

### File List

- M src/app/api/v1/bff/configurator/route.ts
- M src/lib/validators/bff-configurator.ts
- A __tests__/api/v1/bff/configurator.contract.test.ts
 - M __tests__/api/v1/bff/configurator.initialization.test.ts
 - M __tests__/api/v1/bff/configurator.test.ts

---

## Change Log

| Date       | Version | Description                                  | Author |
| ---------- | ------- | -------------------------------------------- | ------ |
| 2025-10-20 | 0.1.0   | 초기 구현: 쿼리 순서 재정렬/스키마 확장/테스트 추가 | James  |
