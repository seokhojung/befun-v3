# 2.3A.1 책상 모델 스펙 문서화 및 타입/검증 반영 (Brownfield Story)

Status: pass
Epic: 2.3A — 책상 도메인/가격 룰 확정
Owner: TBD
Priority: P0
Labels: domain, validation, types, configurator, pricing

## 배경/문맥

컨피규레이터와 카트 사이의 일관된 동작을 위해, 책상(Desk) 파라메트릭 모델의 기준(치수 범위, 스냅 규칙, 단위, 허용 재질/마감)을 “문서 + 타입 + 검증”으로 고정해야 합니다. 현재 가격/재질/사이즈 정의가 일부 미흡하여 불일치/경계값 오류가 발생할 수 있습니다.

## 목표/가치

- 단일 진실원(SSOT)으로 책상 모델 스펙을 문서화하고, 코드 타입/검증(Zod)으로 반영
- 유효하지 않은 입력은 조기 차단(명확한 메시지), 유효 입력은 컨피그/카트에서 동일하게 처리

## 범위

- 포함(In)
  - 책상 모델 스펙 문서: 치수 범위, 스냅 간격, 단위(cm), 허용 재질/마감
  - 타입/검증 스키마: `DeskModelSpec`, `DeskOptionsSchema`(Zod)
  - 에러 메시지 표준(한국어) 및 코드 매핑
  - 샘플 유효/무효 페이로드 캡처(문서 내)
- 제외(Out)
  - 가격 룰 반영(Story 2에서 처리)
  - 재질 카탈로그/시드(Story 3에서 처리)

## 수용 기준 (Acceptance Criteria)

1. 문서화

- Given 개발자/QA가 스펙 문서를 열었을 때
- When 치수/스냅/단위/허용 재질·마감을 확인하면
- Then 값/예시/에러 케이스가 명확히 서술되어 있어야 한다

2. 타입/검증 존재

- Given 코드 기준으로
- When `DeskModelSpec` 타입과 `DeskOptionsSchema`(Zod)가 검색되면
- Then 각 필드 범위/스냅/열거형이 타입/검증에 반영되어야 한다

3. 치수 범위 검증

- Given 폭/깊이/높이의 최소/최대(예: 30–300cm/30–300cm/40–120cm)
- When 범위 밖 값이 들어오면
- Then ValidationError(422)와 한국어 메시지로 응답한다

4. 스냅 규칙

- Given 스냅 간격은 1cm, 최초 릴리스는 "엄격" 정책(정수 cm만 허용, 보정 없음)
- When 100.4cm 등 스냅 미스매치 값이 들어오면
- Then 422 ValidationError와 표준 에러 메시지로 응답한다

5. 단위 일관성

- Given 단위는 cm 기준으로 정의
- When API/프런트에서 mm/inch 등을 전달하려는 경우
- Then 변환 로직 범위를 문서화하고 이번 스토리의 범위를 벗어난다고 명시한다

6. 재질/마감 열거값 검증

- Given 허용 재질(materials: wood/mdf/steel/metal/glass/fabric), 마감(finishes: matte/glossy/satin)
- When 허용 외 값이 들어오면
- Then ValidationError(422)와 일관된 메시지를 반환한다

7. 샘플 페이로드

- Given 문서의 샘플 유효/무효 페이로드
- When 해당 예시로 검증 실행 시
- Then 유효는 통과, 무효는 실패한다

8. 테스트(문서 기반)

- Given 유닛 테스트 8개 이상(경계 3, 열거 2, 색상 1, 스냅 2 이상 포함)
- When 범위/스냅/열거/경계 케이스를 검증하면
- Then 모두 Green이며 메시지 스냅샷이 안정적이다

9. 에러 메시지 표준 포맷

- Given 유효성 실패가 발생했을 때
- When 오류 응답을 확인하면
- Then "입력값이 올바르지 않습니다: <필드명> - <사유>" 포맷(예: width_cm - 허용 범위 30–300)

## 기술 규격 (제안)

- 치수 범위(초안):
  - width_cm: 30–300
  - depth_cm: 30–300
  - height_cm: 40–120
- 스냅(step): 1cm — 최초 릴리스는 "엄격" 정책(정수 cm만 허용, 소수점 입력 시 422, 보정 없음)
- 재질(material): 'wood' | 'mdf' | 'steel' | 'metal' | 'glass' | 'fabric'
- 마감(finish): 'matte' | 'glossy' | 'satin'
- 색상(color): HEX `^#[0-9A-F]{6}$` (대소문자 허용)
- 단위: cm 고정(이번 스토리 범위), 다른 단위는 문서에 out-of-scope로 명시

## 산출물/변경 파일

- 문서
  - docs/architecture/modeling/desk.md (신규)
- 타입/검증
  - src/types/desk.ts (신설): `DeskModelSpec`, `DeskOptions`
  - src/lib/api/validation.ts: `BusinessSchemas.deskOptions` 추가(Zod)
- 테스트
  - **tests**/lib/api/validation.desk.test.ts (신규)

## 작업/세부 태스크 (개발용)

- [x] 스펙 문서 초안 작성(치수·스냅·단위·재질/마감·샘플·경계 케이스)
- [x] 타입 정의 추가(DeskModelSpec/DeskOptions)
- [x] Zod 스키마 구현(범위/스냅/열거/색상 정규식) → `BusinessSchemas.deskOptions`
- [x] 에러 메시지 표준화(한국어, 짧고 명확, 코드 매핑) 및 예시 3건 추가
- [x] 유닛 테스트 작성(경계·무효/유효·대량)
- [ ] 레퍼런스 업데이트(컨피그/가격 요청 스키마가 참조하는 부분 연결만 확인; 가격 룰 변경은 다음 스토리에서 처리)
- [ ] 문서 섹션 구조 고정: Overview / Constraints / Snap Policy / Examples / Error Messages / FAQ

---

## Dev Agent Record

- Agent Model Used: Dev

### Debug Log References

- Unit Test Run: PASS — **tests**/lib/api/validation.desk.test.ts (9/9)
- Unit Test Run: PASS — **tests**/lib/api/errors.validation-status.test.ts (1/1)
- Type Check: FAIL (repo 전체 기준 다수 기존 이슈 — 본 스토리 변경 범위와 무관)

### File List (Added/Modified)

- A docs/architecture/modeling/desk.md — Desk 모델 스펙 문서(엄격 스냅/예시/에러 메시지)
- A src/types/desk.ts — `DeskModelSpec`, `DeskOptions`, `DESK_MODEL_SPEC`
- M src/lib/api/validation.ts — `BusinessSchemas.deskOptions` Zod 스키마 추가(정수 스냅·범위·열거·HEX)
- A **tests**/lib/api/validation.desk.test.ts — 유효/무효/경계/스냅/열거/색상 테스트
- M src/lib/api/errors.ts — transformZodError 표준 포맷 메시지 생성(필드명·사유 포함), ValidationError 상태 422 적용
- A **tests**/lib/api/errors.validation-status.test.ts — 검증 실패 응답이 422인지 확인하는 테스트

### Completion Notes

- QA 지적사항 반영: 테스트 9개로 보강(경계/소문자 HEX/finish optional/메시지 포맷), transformZodError 표준 포맷 적용.
- 스펙/타입/검증/테스트 초안 완료. 레퍼런스 연결 점검 필요.
- develop-story 검증 단계: 변경 범위 유닛 테스트는 Green. 전역 type-check는 기존 실패가 다수 존재하여 본 스토리에서 해결 범위를 넘음(보고 및 분리 필요).

### DoD Checklist (preliminary)

- [x] 스토리 Acceptance Criteria 충족(문서/타입/검증/샘플/테스트)
- [x] 변경 파일 목록 반영 및 기록
- [ ] 전역 타입/테스트 회귀 Green(현 시점: 전역 TypeScript 에러 다수 존재 — 별도 에픽/스토리로 분리 필요)

### Change Log

- 2025-10-14: 초기 구현(문서/타입/검증/테스트) 추가 — Dev
- 2025-10-14: QA fixes 적용 — 테스트 보강(총 9개), 에러 메시지 표준 포맷 적용(transformZodError)
- 2025-10-14: QA follow-up — 검증 실패 HTTP 상태 422 적용 및 단위 테스트 추가

## 테스트 전략

- 유닛: Zod 스키마(경계/열거/정규식/스냅) — 실패 시 메시지 스냅샷
- 통합(선택): pricing.calculate 요청에 DeskOptionsSchema 이식 확인(현재는 연결만 확인)
- 부하(선택): 대량 케이스 1000개 validate 성능 체크(임계: < 100ms)

## 위험/의존성

- 의존성: 2.3A 에픽 내 Story 2(가격 룰), Story 3(재질 카탈로그)와 연동됨
- 위험: 스냅 정책(보정 vs 엄격)이 UX에 영향 — 이번 스토리는 “엄격”으로 고정하고 문서화
- 롤백: 타입/스키마 feature flag는 필요 없음, 메시지/정책만 문서 revert 가능

## 완료 정의 (DoD)

- [ ] 문서/타입/스키마 정합성 확보
- [ ] 유닛 테스트 Green(경계/열거/정규식/스냅)
- [ ] 컨피그/카트에 파급 영향 없음(컴파일·타입 에러 0)

## 샘플 페이로드

- 유효

```json
{
  "width_cm": 120,
  "depth_cm": 60,
  "height_cm": 75,
  "material": "wood",
  "finish": "matte",
  "color": "#8B4513"
}
```

- 무효(예)

```json
{
  "width_cm": 15,
  "depth_cm": 500,
  "height_cm": 35,
  "material": "plastic",
  "finish": "ultra",
  "color": "brown"
}
```

---

Story Manager Note: 이 스토리는 문서/타입/검증을 잠그는 도메인 기반 작업입니다. 가격 룰/재질 시드는 후속 스토리에서 다룹니다.

---

## PO Validation Results (2.3A.1)

결론: Needs Revisions (소폭 보완 후 승인 가능)

요약

- 목적/가치, 범위(In/Out), A/C, 산출물, 테스트 전략이 명확하며 구현 가능성 높음.
- 실제 코드 기준 명칭/경로와의 정합성, 스냅 정책의 최종 결정(보정 vs 엄격) 명시, 에러 메시지 표준 포맷 보완이 필요.

필수 보완 사항

1. 스냅 정책 단일화 및 문구 고정
   - 현재 “엄격 검증(보정 없음)”으로 제안되어 있으나, 최종 결정을 명시해야 함.
   - 권장: 최초 릴리스는 “엄격(정수 cm만 허용, 소수점 입력 시 422)”로 고정. 추후 보정 모드 전환은 별도 스토리.

2. 스키마/타입 명칭 정합성
   - 현 코드 `src/lib/api/validation.ts`는 `CommonSchemas`, `BusinessSchemas` 네임스페이스 사용 중.
   - 제안: `BusinessSchemas`에 `deskOptions` 추가(케이스 일관: camelCase). 파일 내 명시: `export const BusinessSchemas = { ..., deskOptions: z.object({...}) }`.
   - 타입은 `src/types/desk.ts` 신설 권장(또는 `src/types/pricing.ts` 내 섹션 구분). 명칭: `DeskModelSpec`, `DeskOptions`.

3. 에러 메시지 표준화(한국어)
   - 포맷: "입력값이 올바르지 않습니다: <필드명> - <사유>" (예: width_cm - 허용 범위 30–300)
   - 색상: "올바른 색상 코드 형식이 아닙니다(예: #112233)" — 기존 메시지와 톤 일치.

4. Acceptance Criteria 정량 지표 보강
   - 테스트 최소 수: 8 → 구체 분배 명시(경계 3, 열거 2, 색상 1, 스냅 2 등)로 가이드 강화.
   - 성능(선택): 1,000건 validate < 100ms(현 제안 유지) 수치 Story에 고정.

5. 문서 경로 명시
   - `docs/architecture/modeling/desk.md` 섹션 구조 제안 포함: Overview / Constraints / Snap Policy / Examples / Error Messages / FAQ.

정합성 체크(OK 항목)

- A/C는 Given/When/Then 구조로 테스트 가능한 문장.
- 범위에서 가격 룰/재질 시드를 제외하여 스토리 간 경계 명확.
- 샘플 페이로드(유효/무효) 제공.

권장 편집안(스토리에 반영)

- 스냅 정책 문단에 “엄격 검증(정수 cm만 허용, 보정 없음)”을 굵게 명시.
- 스키마/타입 명칭을 본문에 구체적으로 표기(예시 코드 라인 수준으로 경로 포함).
- 에러 메시지 예시 3개 추가(width_cm 범위, material 열거, color 형식).

승인 조건

- 상기 1–3번 보완 반영 후 재검토 시 승인(Approved) 전환.

---

## SM Story Checklist (2.3A.1)

결론: PASS with minor actions

- 목적/가치 명확성: PASS — SSOT 확립과 검증 일관성 명확
- 범위 경계(In/Out): PASS — 가격/재질은 후속 스토리로 분리
- 수용 기준 테스트 가능성: PASS — G/W/T 구문, 수량·메시지 기준 포함
- 의존성/리스크 명시: PASS — 스냅 정책 고정, 후속 스토리 연계 명시
- 데이터 계약/타입 경로: CONCERNS — 파일 경로와 식별자(DeskModelSpec/BusinessSchemas.deskOptions) 예시 코드 스니펫 추가 권장
- 에러 메시지 표준: CONCERNS — 예시 3건을 본문에 즉시 추가 권장
- 테스트 전략/커버리지: PASS — 분배 기준 명시(≥8), 성능 임계 포함
- 문서 아웃라인: CONCERNS — desk.md 섹션 프레임(Overview/Constraints/Snap/Examples/Errors/FAQ) 본문에 표기 필요

Action Items

1. 타입/스키마 선언 예시(짧은 코드 블록) 추가: `BusinessSchemas.deskOptions = z.object({...})`
2. 에러 메시지 예시 3건 삽입: width_cm 범위, material 열거, color 형식
3. desk.md 섹션 구조를 본문에 한 줄로 고정 표기

---

## QA Results (2.3A.1)

결론: PASS

요약

- 문서/타입/검증 구현 상태 양호. 스냅(정수 cm), 범위, 열거, 색상 정규식이 코드에 반영됨.
- 단위 테스트 보강 완료(총 10개: 데스크 9, 에러 상태 1) 및 분배 충족. 메시지 포맷 표준화 적용 확인.
- ValidationError HTTP 상태 코드 422 적용 확인.

트레이서빌리티(AC 대비)

- AC1 문서화: PASS — docs/architecture/modeling/desk.md:1
- AC2 타입/검증 존재: PASS — src/types/desk.ts:1, src/lib/api/validation.ts:74
- AC3 범위 검증: PASS — ValidationError 422 적용 (src/lib/api/errors.ts:30, **tests**/lib/api/errors.validation-status.test.ts:1)
- AC4 스냅 규칙(정수 cm): PASS — 규칙 및 실패 시 422 확인
- AC5 단위 일관성(cm, 타 단위 Out-of-scope 문서화): PASS — docs/architecture/modeling/desk.md:1
- AC6 재질/마감 열거: PASS — src/lib/api/validation.ts:92,95
- AC7 샘플 페이로드: PASS — docs/architecture/modeling/desk.md:18,39
- AC8 테스트(≥8, 분배/스냅샷): PASS — **tests**/lib/api/validation.desk.test.ts:3 (9/9)
- AC9 에러 메시지 표준 포맷: PASS — src/lib/api/errors.ts:216(transformZodError)

증거(Evidence)

- 타입/스펙: src/types/desk.ts:1, docs/architecture/modeling/desk.md:1
- 스키마: src/lib/api/validation.ts:74 (BusinessSchemas.deskOptions)
- 테스트: **tests**/lib/api/validation.desk.test.ts:3 (it 9개), **tests**/lib/api/errors.validation-status.test.ts:1 (it 1개)

권고/필수 조치(Must-fix)

- (없음) — 모든 AC 충족

리스크/비고

- 기능적 리스크 낮음(스키마/타입/문서 정합성 양호). 성능(배치 1000건 < 100ms)은 선택 항목으로 별도 추후 검증 가능.

재검토/승인 조건

- N/A — 본 리뷰로 PASS 승인.
