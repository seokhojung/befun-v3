# Story 1.2D: React 무한 루프 긴급 수정 - 컨피규레이터 페이지

## Status

In Progress

## Story

**As a** 개발자,
**I want** /configurator 페이지의 React 무한 루프를 완전히 해결,
**So that** 사용자가 3D 컨피규레이터를 정상적으로 사용할 수 있습니다.

## Story Context

이 스토리는 Story 1.2C (BLOCKED)에서 분리된 긴급 수정 스토리입니다. Story 1.2C에서 여러 차례 시도했으나 해결하지 못한 React 무한 루프 문제를 집중적으로 해결합니다.

**분리 배경:**
- Story 1.2C가 너무 많은 이슈를 포함 (Epic 1, 2, 3의 이슈 혼재)
- Dev Agent의 부분적 수정만으로는 해결 불가능
- 컴포넌트 간 복잡한 상호 의존성 문제

**근본 원인 (QA 분석):**
1. ConfiguratorUI ↔ ControlPanel ↔ ThreeCanvas 간 순환 참조
2. useEffect 의존성 배열 관리 문제
3. props drilling으로 인한 불필요한 리렌더링 전파

## Acceptance Criteria

1. `/configurator` 페이지 접근 시 "Maximum update depth exceeded" 에러가 발생하지 않아야 함
2. 브라우저 크래시 없이 페이지가 정상적으로 로드되어야 함
3. 3D 씬이 정상적으로 표시되어야 함
4. Slider 조작 시 무한 루프가 발생하지 않아야 함
5. 재료 선택 시 무한 루프가 발생하지 않아야 함
6. 브라우저 콘솔에 React 무한 루프 관련 에러가 없어야 함
7. 성능: 모바일에서 최소 30 FPS 유지 (NFR1 준수)
8. 일반 상호작용(슬라이더 드래그/재료 변경/뷰 회전) 동안 콘솔 경고·에러가 없어야 함

## Tasks / Subtasks

- [ ] **Task 1: 현재 무한 루프 원인 정밀 분석** (AC: 1, 6)
  - [ ] React DevTools Profiler로 렌더링 체인 분석
  - [ ] useEffect 의존성 배열 전체 점검
  - [ ] props 전달 구조 맵핑
  - [ ] 콘솔 에러 스택 트레이스 분석

- [ ] **Task 2: ConfiguratorUI 컴포넌트 리팩토링** (AC: 1, 2, 3)
  - [ ] useEffect 의존성 최적화
  - [ ] useRef 패턴으로 불필요한 리렌더링 방지
  - [ ] handleSettingsChange useCallback 최적화
  - [ ] BFF API 호출 로직 안정화
  - [ ] 디바운스 타이머 클린업 및 콜백 안정성 보장 (`clearTimeout`, ref-stable)
  - [ ] BFF 엔드포인트 명시 및 루프 미유발 검증: `/api/v1/bff/configurator`, `/api/v1/bff/design-summary`

- [ ] **Task 3: ControlPanel 컴포넌트 리팩토링** (AC: 4, 5)
  - [ ] Controlled vs Uncontrolled 컴포넌트 패턴 결정
  - [ ] localDimensions 상태 관리 개선
  - [ ] debouncing 로직 최적화
  - [ ] stale closure 문제 해결

- [ ] **Task 4: ThreeCanvas 컴포넌트 최적화** (AC: 3, 7)
  - [ ] useEffect 의존성 배열 최적화
  - [ ] Three.js 씬 초기화 로직 개선
  - [ ] 성능 모니터링 콜백 최적화
  - [ ] 메모리 누수 방지

- [ ] **Task 5: 컴포넌트 간 데이터 흐름 재설계** (AC: 1, 4, 5)
  - [ ] props drilling 제거 검토
  - [ ] 상태 관리 패턴 개선 (Context API 또는 상태 끌어올리기)
  - [ ] 이벤트 핸들러 최적화
  - [ ] 불필요한 prop 전달 제거
  - [ ] 가격 업데이트 디바운스 500ms로 통일(가이드 준수), UI 반응성은 로컬 상태로 보장
  - [ ] API 응답에 따른 상태 동기화가 재렌더 루프를 유발하지 않는지 확인 (idempotent 업데이트)

- [ ] **Task 6: 통합 테스트 및 검증** (AC: 1-7)
  - [ ] 브라우저 수동 테스트 (Chrome, Safari, Firefox)
  - [ ] 모바일 테스트 (iOS, Android)
  - [ ] React DevTools로 렌더링 최적화 확인
  - [ ] 성능 메트릭 측정 (FPS, 메모리 사용량)

- [ ] **Task 7: 회귀 방지 테스트 작성** (AC: 6)
  - [ ] 무한 루프 감지 E2E 테스트 작성
  - [ ] 컴포넌트 단위 테스트 추가
  - [ ] CI/CD 파이프라인에 테스트 통합

## Dev Notes

### 기술 스택 정보
[Source: architecture/tech-stack-안정-버전-확정.md]
- **Frontend Framework**: Next.js 14.x
- **Language**: TypeScript 5.3.x (strict mode)
- **3D Rendering**: Three.js r169 (고정 버전)
- **UI/Styling**: Tailwind CSS 3.x
- **Runtime**: Node.js v20.x (LTS)

### 아키텍처 정보
[Source: architecture/component-analysis-선택-근거-및-위험-분석.md]
- **Architecture Style**: Serverless + Monorepo
- **Core Component**: BFF (API Gateway Service) 패턴
- **Risk**: Cold Start 지연 발생 시 UX 저하
- **Mitigation**: Warm-up 전략 및 Next.js Serverless Functions 최적화

### 현재 파일 구조
- `/src/app/configurator/page.tsx` - 메인 페이지 (dynamic import, Error Boundary 적용)
- `/src/app/configurator/components/ConfiguratorUI.tsx` - 메인 UI 컴포넌트
- `/src/app/configurator/components/ControlPanel.tsx` - 컨트롤 패널
- `/src/components/three/ThreeCanvas.tsx` - 3D 렌더링 컴포넌트
- `/src/components/error-boundary/ConfiguratorErrorBoundary.tsx` - 에러 경계

### 이전 스토리(1.2C) 교훈
[Source: Story 1.2C QA Results]

**실패한 수정 시도들:**
1. useRef + debouncing 패턴 → 불완전한 구현으로 실패
2. defaultValue로 Slider 변경 → UI 불일치 문제 발생
3. useEffect 의존성 배열 수정 → 부분적 수정으로 해결 안 됨

**QA가 제안한 해결 방법들:**

**Option A (권장): Controlled + useRef로 리렌더 방지**
```typescript
const [localDimensions, setLocalDimensions] = useState(settings.dimensions)

useEffect(() => {
  setLocalDimensions(settings.dimensions)
}, [settings.dimensions])

const handleDimensionChange = (dimension, value) => {
  const newDims = { ...localDimensions, [dimension]: value }
  setLocalDimensions(newDims)  // 즉시 UI 업데이트

  // Debounce는 onSettingsChange만
  if (debounceTimerRef.current) clearTimeout(debounceTimerRef.current)
  debounceTimerRef.current = setTimeout(() => {
    onSettingsChange({ ...settings, dimensions: newDims })
  }, 500)
}
// 컴포넌트 언마운트/의존성 변경 시 타이머 클린업
useEffect(() => () => { if (debounceTimerRef.current) clearTimeout(debounceTimerRef.current) }, [])
```

**Option B: onValueCommit 사용**
```typescript
<Slider
  value={[mToCm(settings.dimensions.width)]}
  onValueCommit={(value) => {  // 드래그 완료 시만 호출
    handleDimensionChange('width', cmToM(value[0]))
  }}
/>
```

**handleSettingsChange useCallback 최적화:**
```typescript
const availableMaterialsRef = useRef(availableMaterials)
const calculatePriceRef = useRef(calculatePrice)

useEffect(() => {
  availableMaterialsRef.current = availableMaterials
  calculatePriceRef.current = calculatePrice
}, [availableMaterials, calculatePrice])

const handleSettingsChange = useCallback((newSettings) => {
  setSettings(newSettings)

  const currentMaterial = availableMaterialsRef.current.find(...)
  if (currentMaterial) {
    calculatePriceRef.current({...})
  }
}, [])  // 빈 의존성 배열!
```

### Testing Standards

- 테스트 위치: `__tests__/` (components, lib, api, e2e, performance 등 서브폴더)
- 유닛/컴포넌트 테스트: Jest + React Testing Library (`jest.config.js`, `jest.setup.js` 참고)
- E2E 테스트: Playwright (`playwright.config.ts`), 관련 스펙: `__tests__/e2e/configurator/infinite-loop-fix.e2e.test.tsx`
- 성능 테스트(AC7): FPS 측정 방식 명시
  - 샘플링: `requestAnimationFrame` 기반 평균 FPS 2–3초 측정
  - 합격 기준: 평균 FPS ≥ 30 (모바일 환경 시뮬레이션)
  - 리그레션 방지: 상호작용(슬라이더 드래그/재료 변경) 동안 FPS 하락 여부 로깅 및 임계치 검증
  - 관련 파일: `__tests__/performance/configurator.test.ts`

### 중요 제약사항

1. **성능 요구사항 (NFR1)**: 모바일에서 30 FPS 이상 유지
2. **브라우저 호환성**: Chrome, Safari, Firefox 최신 2개 버전
3. **TypeScript strict mode** 준수
4. **Three.js r169** 버전 고정 (변경 금지)

## Change Log

| Date | Version | Description | Author |
|:-----|:--------|:------------|:-------|
| 2025-10-02 | 1.0 | Initial story creation from 1.2C split | Bob (SM) |
| 2025-10-10 | 1.1 | ThreeCanvas onInitError, Configurator Init Watchdog(5s) 추가로 무한 로딩 완화 | Dev Agent |
| 2025-10-10 | 1.2 | ThreeCanvas 렌더 분기 수정: 항상 캔버스 렌더 + 오버레이(로딩/에러)로 전환 | Dev Agent |

## Dev Agent Record

### Agent Model Used
Codex CLI Dev Agent (OpenAI) – Node v20 / TS 5.3

### Debug Log References
- 00console-error-log.txt: 무한 루프 직접 재현 로그는 없으나, PurchaseSection null 참조로 인한 에러 트리 복구 관찰
- React 경고("Cannot update a component (HotReload) while rendering…")는 HMR/개발 환경 영향으로 우선 무시, 재현 시 포커싱 예정

### Completion Notes List
- ConfiguratorUI 렌더 분기에서 cartData null 가드 추가로 런타임 오류 제거(무한 루프 이슈와 별개 안정화)
- 1.2C 교훈 반영된 useRef/useCallback 패턴은 유지, 추가 리팩터링(Profiler 기반) 대기
- 무한 루프 재현 스텝 명확화 필요(슬라이더 드래그/재료 변경/네트워크 지연 조합)
- ThreeCanvas onInitError 콜백, ConfiguratorUI Init Watchdog(5s) 추가로 로딩 블로킹 완화
- ThreeCanvas/Configurator 단계별 로깅 추가(render start, mountReady 변화, init 단계, isLoading 변화)
 - 로그 레벨 조정: console.debug → console.log로 상향(브라우저 기본 필터에서 보이도록)

### File List
- src/app/configurator/components/ConfiguratorUI.tsx (null 가드)
- src/components/three/ThreeCanvas.tsx (onInitError 콜백 추가)

### Dev Checklist (Brownfield)
- [x] 증상 재현 및 로그 수집(00console-error-log.txt 반영)
- [x] 최소 안전 가드 추가(onInitError, Init Watchdog) – 전면 블로킹 해제 목적
- [x] 렌더 분기 수정(항상 캔버스 + 오버레이)
- [ ] 초기화 단계 로깅 보강(onSceneReady 호출 시점/실패 시점 추적)
- [ ] BFF 의존 경로 폴백 재검토(초기 화면 진입 보장)
- [ ] Profiler 기반 재렌더 루프 분석 및 리팩토링

### Dev Checklist (Brownfield)
- [x] 스토리 문서 Dev Agent Record 업데이트
- [x] 최근 안정화 변경 내역 반영(null 가드)
- [ ] Profiler 기반 렌더링 체인 분석(무한 루프 재현 경로 포함)
- [ ] ControlPanel/ThreeCanvas 의존성/디바운스 최적화 리팩토링
- [ ] 성능 및 회귀 방지 테스트 보강

## QA Results

게이트 결정: CONCERNS

요약(재검증)
- 컨피규레이터 실행 정상, 3D 씬 표시 확인. 초기화 무한 상태 해소(항상 캔버스 + 오버레이 전략 적용).
- 가격 로그 폭주 해결(동일 total 반복 콜백 억제). 상호작용 중 무한 루프 없음.
- 성능/회귀 테스트 및 모바일 FPS 측정은 미완료 상태로 남아 있어 게이트는 CONCERNS로 유지.

AC 재검토 결과
- AC1 Maximum update depth 오류 없음: PASS
- AC2 정상 로드: PASS
- AC3 3D 씬 표시: PASS
- AC4 Slider 조작 시 무한 루프 없음: PASS(수동 상호작용 검증)
- AC5 재료 선택 시 무한 루프 없음: PASS(수동 상호작용 검증)
- AC6 콘솔 무에러: PASS(주요 오류/폭주 로그 제거 확인)
- AC7 성능(모바일 ≥30FPS): CONCERNS(측정 미완료)
- AC8 일반 상호작용 중 경고·에러 없음: CONCERNS(회귀 방지 테스트 보강 필요)

리스크/권고(업데이트)
- 성능 측정/회귀 방지 테스트 보강 후 PASS 재평가 권고.

근거(Evidence)
- 로그: 00console-error-log.txt – 무한 로딩 및 HotReload 경고, cartData null 예외(가드 후 완화).
- 코드: ConfiguratorUI null 가드 반영(안정화 일부), 초기화/콜백 경로는 추가 점검 필요.

결론(Gate)
- FAIL – 초기화 실패로 핵심 AC 다수가 미충족. 위 Must-Fix 수행 후 재검증 권고.
