# Story 1.2E: user_profiles 테이블 마이그레이션 완료 및 자동화

## Status

Draft

## Story

**As a** 개발팀,
**I want** user_profiles 테이블 마이그레이션을 완료하고 자동화 스크립트를 작성,
**So that** 모든 사용자가 프로필 데이터를 가지고 BFF API가 정상 작동하며, 향후 데이터 누락 문제를 방지할 수 있습니다.

## Story Context

이 스토리는 Story 1.2C에서 발견된 user_profiles 테이블 레코드 누락 문제를 완전히 해결하고 자동화하는 스토리입니다.

**배경:**
- Story 1.2C 테스트 중 `test01@test.test` 사용자의 user_profiles 레코드 누락 발견
- BFF API (`/api/v1/bff/configurator`) 500 에러 원인
- PO Agent가 수동으로 SQL 실행하여 임시 해결
- 근본 원인: `handle_new_user()` 트리거가 특정 상황에서 실행되지 않음

**이미 완료된 작업 (Story 1.2C):**
- `test01@test.test` 사용자 레코드 수동 생성 완료
- user_profiles, user_settings 테이블에 데이터 삽입
- RLS 정책 검증 완료

**이번 스토리에서 할 작업:**
- 자동화 스크립트 작성
- 기존 사용자 데이터 검증
- 트리거 함수 동작 확인 및 개선

## Acceptance Criteria

1. 모든 기존 `auth.users` 레코드가 대응하는 `user_profiles` 레코드를 가져야 함
2. 누락된 user_profiles 레코드를 찾아 생성하는 SQL 스크립트가 작성되어야 함
3. `handle_new_user()` 트리거 함수가 모든 경우에 정상 작동해야 함
4. 데이터 마이그레이션 스크립트가 재사용 가능하고 파라미터화되어야 함
5. 스크립트 실행 시 이미 존재하는 레코드는 건너뛰어야 함 (중복 방지)
6. 마이그레이션 실행 로그가 기록되어야 함
7. 테스트 사용자로 검증이 완료되어야 함

## Tasks / Subtasks

- [ ] **Task 1: 기존 데이터 현황 분석** (AC: 1)
  - [ ] auth.users 테이블 전체 레코드 수 확인
  - [ ] user_profiles 테이블 레코드 수 확인
  - [ ] 누락된 레코드 식별 (LEFT JOIN 쿼리)
  - [ ] 데이터 불일치 리포트 작성

- [ ] **Task 2: 마이그레이션 스크립트 작성** (AC: 2, 4, 5)
  - [ ] `docs/scripts/migrate-user-profiles.sql` 파일 생성
  - [ ] 누락 레코드 자동 감지 로직 작성
  - [ ] INSERT ... ON CONFLICT DO NOTHING 구문 사용
  - [ ] 파라미터화 (날짜 범위, 특정 사용자 등)

- [ ] **Task 3: handle_new_user() 트리거 개선** (AC: 3)
  - [ ] 현재 트리거 함수 동작 분석
  - [ ] 실패 케이스 식별 (OAuth, 소셜 로그인 등)
  - [ ] 트리거 함수 개선 또는 fallback 로직 추가
  - [ ] 트리거 테스트 케이스 작성

- [ ] **Task 4: 재사용 가능한 유틸리티 스크립트 작성** (AC: 4)
  - [ ] `scripts/check-user-profiles.sql` - 데이터 검증 스크립트
  - [ ] `scripts/create-single-user-profile.sql` - 단일 사용자 생성
  - [ ] `scripts/bulk-migrate-users.sql` - 대량 마이그레이션
  - [ ] 각 스크립트에 사용법 주석 추가

- [ ] **Task 5: 마이그레이션 실행 및 로깅** (AC: 6)
  - [ ] 마이그레이션 실행 전 백업 확인
  - [ ] 스크립트 실행 (dry-run 먼저)
  - [ ] 실행 결과 로그 기록
  - [ ] 데이터 검증 (전후 비교)

- [ ] **Task 6: 테스트 및 검증** (AC: 7)
  - [ ] 새 테스트 사용자 생성 → user_profiles 자동 생성 확인
  - [ ] BFF API 호출 테스트 (500 에러 없음 확인)
  - [ ] 기존 사용자 로그인 테스트
  - [ ] RLS 정책 동작 확인

## Dev Notes

### 데이터베이스 구조
[Source: supabase/migrations/20250925_create_auth_tables.sql]

**user_profiles 테이블:**
```sql
CREATE TABLE public.user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL UNIQUE,
  full_name TEXT,
  avatar_url TEXT,
  phone TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc', now()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc', now())
);
```

**user_settings 테이블:**
```sql
CREATE TABLE public.user_settings (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  theme VARCHAR(20) DEFAULT 'system',
  notifications_enabled BOOLEAN DEFAULT true,
  language VARCHAR(10) DEFAULT 'ko',
  measurement_unit VARCHAR(10) DEFAULT 'cm',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc', now()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc', now())
);
```

**현재 트리거 함수:**
```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.user_profiles (id, email, full_name)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'full_name', NEW.email)
  );

  INSERT INTO public.user_settings (id)
  VALUES (NEW.id);

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### RLS (Row Level Security) 정책
[Source: supabase/migrations/20250925_create_auth_tables.sql]

```sql
ALTER TABLE public.user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_settings ENABLE ROW LEVEL SECURITY;

-- 사용자는 자신의 프로필만 조회/수정 가능
CREATE POLICY "Users can view own profile"
  ON public.user_profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON public.user_profiles FOR UPDATE
  USING (auth.uid() = id);
```

### 이미 완료된 수동 수정 (참고용)
[Source: Story 1.2C Task 3]

**PO Agent가 실행한 SQL:**
```sql
-- test01@test.test 사용자 레코드 생성
INSERT INTO public.user_profiles (
  id,
  email,
  full_name,
  created_at,
  updated_at
) VALUES (
  '93cf9597-e8e8-4e79-874f-fe03c56532c2',
  'test01@test.test',
  'Test User 01',
  '2025-10-01 06:34:47',
  '2025-10-01 06:34:47'
);

INSERT INTO public.user_settings (
  id,
  created_at,
  updated_at
) VALUES (
  '93cf9597-e8e8-4e79-874f-fe03c56532c2',
  '2025-10-01 06:34:47',
  '2025-10-01 06:34:47'
);
```

### 예상 마이그레이션 스크립트 구조

```sql
-- 누락된 user_profiles 레코드 찾기 및 생성
WITH missing_users AS (
  SELECT
    u.id,
    u.email,
    u.raw_user_meta_data,
    u.created_at
  FROM auth.users u
  LEFT JOIN public.user_profiles p ON u.id = p.id
  WHERE p.id IS NULL
)
INSERT INTO public.user_profiles (id, email, full_name, created_at, updated_at)
SELECT
  id,
  email,
  COALESCE(raw_user_meta_data->>'full_name', email),
  created_at,
  created_at
FROM missing_users
ON CONFLICT (id) DO NOTHING;

-- user_settings도 동일하게 처리
WITH missing_settings AS (
  SELECT u.id, u.created_at
  FROM auth.users u
  LEFT JOIN public.user_settings s ON u.id = s.id
  WHERE s.id IS NULL
)
INSERT INTO public.user_settings (id, created_at, updated_at)
SELECT id, created_at, created_at
FROM missing_settings
ON CONFLICT (id) DO NOTHING;
```

### 테스트 환경 정보
[Source: architecture/tech-stack-안정-버전-확정.md]
- **Database**: Supabase PostgreSQL 15
- **Auth**: Supabase Auth (auth.users 테이블)
- **Development**: Local Supabase 또는 Cloud 인스턴스

### 파일 위치
- **마이그레이션 스크립트**: `/docs/scripts/` 디렉토리에 생성
- **기존 마이그레이션**: `/supabase/migrations/`
- **테스트 스크립트**: `/__tests__/migrations/` (옵션)

## Change Log

| Date | Version | Description | Author |
|:-----|:--------|:------------|:-------|
| 2025-10-02 | 1.0 | Initial story creation from 1.2C split | Bob (SM) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_