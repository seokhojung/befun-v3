# Story 1.2E: user_profiles 테이블 마이그레이션 완료 및 자동화

## Status

Ready for Review

## Story

**As a** 개발팀,
**I want** user_profiles 테이블 마이그레이션을 완료하고 자동화 스크립트를 작성,
**So that** 모든 사용자가 프로필 데이터를 가지고 BFF API가 정상 작동하며, 향후 데이터 누락 문제를 방지할 수 있습니다.

## Story Context

이 스토리는 Story 1.2C에서 발견된 user_profiles 테이블 레코드 누락 문제를 완전히 해결하고 자동화하는 스토리입니다.

**배경:**

- Story 1.2C 테스트 중 `test01@test.test` 사용자의 user_profiles 레코드 누락 발견
- BFF API (`/api/v1/bff/configurator`) 500 에러 원인
- PO Agent가 수동으로 SQL 실행하여 임시 해결
- 근본 원인: `handle_new_user()` 트리거가 특정 상황에서 실행되지 않음

**이미 완료된 작업 (Story 1.2C):**

- `test01@test.test` 사용자 레코드 수동 생성 완료
- user_profiles, user_settings 테이블에 데이터 삽입
- RLS 정책 검증 완료

**이번 스토리에서 할 작업:**

- 자동화 스크립트 작성
- 기존 사용자 데이터 검증
- 트리거 함수 동작 확인 및 개선

## Acceptance Criteria

1. 모든 기존 `auth.users` 레코드가 대응하는 `user_profiles` 레코드를 가져야 함
2. 누락된 user_profiles 레코드를 찾아 생성하는 SQL 스크립트가 작성되어야 함
3. `handle_new_user()` 트리거 함수가 모든 경우에 정상 작동해야 함
4. 데이터 마이그레이션 스크립트가 재사용 가능하고 파라미터화되어야 함
5. 스크립트 실행 시 이미 존재하는 레코드는 건너뛰어야 함 (중복 방지)
6. 마이그레이션 실행 로그가 기록되어야 함
7. 테스트 사용자로 검증이 완료되어야 함

## Tasks / Subtasks

- [ ] **Task 1: 기존 데이터 현황 분석** (AC: 1)
  - [ ] auth.users 테이블 전체 레코드 수 확인
  - [ ] user_profiles 테이블 레코드 수 확인
  - [ ] 누락된 레코드 식별 (LEFT JOIN 쿼리)
  - [ ] 데이터 불일치 리포트 작성

- [ ] **Task 2: 마이그레이션 스크립트 작성** (AC: 2, 4, 5)
  - [ ] `docs/scripts/migrate-user-profiles.sql` 파일 생성
  - [ ] 누락 레코드 자동 감지 로직 작성
  - [ ] INSERT ... ON CONFLICT DO NOTHING 구문 사용
  - [ ] 파라미터화 (날짜 범위, 특정 사용자 등)

- [ ] **Task 3: handle_new_user() 트리거 개선** (AC: 3)
  - [ ] 현재 트리거 함수 동작 분석
  - [ ] 실패 케이스 식별 (OAuth, 소셜 로그인 등)
  - [ ] 트리거 함수 개선 또는 fallback 로직 추가
  - [ ] 트리거 테스트 케이스 작성

- [ ] **Task 4: 재사용 가능한 유틸리티 스크립트 작성** (AC: 4)
  - [ ] `scripts/check-user-profiles.sql` - 데이터 검증 스크립트
  - [ ] `scripts/create-single-user-profile.sql` - 단일 사용자 생성
  - [ ] `scripts/bulk-migrate-users.sql` - 대량 마이그레이션
  - [ ] 각 스크립트에 사용법 주석 추가

- [ ] **Task 5: 마이그레이션 실행 및 로깅** (AC: 6)
  - [ ] 마이그레이션 실행 전 백업 확인
  - [ ] 스크립트 실행 (dry-run 먼저)
  - [ ] 실행 결과 로그 기록
  - [ ] 데이터 검증 (전후 비교)

- [ ] **Task 6: 테스트 및 검증** (AC: 7)
  - [ ] 새 테스트 사용자 생성 → user_profiles 자동 생성 확인
  - [ ] BFF API 호출 테스트 (500 에러 없음 확인)
  - [ ] 기존 사용자 로그인 테스트
  - [ ] RLS 정책 동작 확인

## Dev Notes

### 데이터베이스 구조

[Source: supabase/migrations/20250925_create_auth_tables.sql]

**user_profiles 테이블:**

```sql
CREATE TABLE public.user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL UNIQUE,
  full_name TEXT,
  avatar_url TEXT,
  phone TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc', now()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc', now())
);
```

**user_settings 테이블:**

```sql
CREATE TABLE public.user_settings (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  theme VARCHAR(20) DEFAULT 'system',
  notifications_enabled BOOLEAN DEFAULT true,
  language VARCHAR(10) DEFAULT 'ko',
  measurement_unit VARCHAR(10) DEFAULT 'cm',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc', now()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc', now())
);
```

**현재 트리거 함수:**

```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.user_profiles (id, email, full_name)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'full_name', NEW.email)
  );

  INSERT INTO public.user_settings (id)
  VALUES (NEW.id);

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### RLS (Row Level Security) 정책

[Source: supabase/migrations/20250925_create_auth_tables.sql]

```sql
ALTER TABLE public.user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_settings ENABLE ROW LEVEL SECURITY;

-- 사용자는 자신의 프로필만 조회/수정 가능
CREATE POLICY "Users can view own profile"
  ON public.user_profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON public.user_profiles FOR UPDATE
  USING (auth.uid() = id);
```

### 이미 완료된 수동 수정 (참고용)

[Source: Story 1.2C Task 3]

**PO Agent가 실행한 SQL:**

```sql
-- test01@test.test 사용자 레코드 생성
INSERT INTO public.user_profiles (
  id,
  email,
  full_name,
  created_at,
  updated_at
) VALUES (
  '93cf9597-e8e8-4e79-874f-fe03c56532c2',
  'test01@test.test',
  'Test User 01',
  '2025-10-01 06:34:47',
  '2025-10-01 06:34:47'
);

INSERT INTO public.user_settings (
  id,
  created_at,
  updated_at
) VALUES (
  '93cf9597-e8e8-4e79-874f-fe03c56532c2',
  '2025-10-01 06:34:47',
  '2025-10-01 06:34:47'
);
```

### 예상 마이그레이션 스크립트 구조

```sql
-- 누락된 user_profiles 레코드 찾기 및 생성
WITH missing_users AS (
  SELECT
    u.id,
    u.email,
    u.raw_user_meta_data,
    u.created_at
  FROM auth.users u
  LEFT JOIN public.user_profiles p ON u.id = p.id
  WHERE p.id IS NULL
)
INSERT INTO public.user_profiles (id, email, full_name, created_at, updated_at)
SELECT
  id,
  email,
  COALESCE(raw_user_meta_data->>'full_name', email),
  created_at,
  created_at
FROM missing_users
ON CONFLICT (id) DO NOTHING;

-- user_settings도 동일하게 처리
WITH missing_settings AS (
  SELECT u.id, u.created_at
  FROM auth.users u
  LEFT JOIN public.user_settings s ON u.id = s.id
  WHERE s.id IS NULL
)
INSERT INTO public.user_settings (id, created_at, updated_at)
SELECT id, created_at, created_at
FROM missing_settings
ON CONFLICT (id) DO NOTHING;
```

### 테스트 환경 정보

[Source: architecture/tech-stack-안정-버전-확정.md]

- **Database**: Supabase PostgreSQL 15
- **Auth**: Supabase Auth (auth.users 테이블)
- **Development**: Local Supabase 또는 Cloud 인스턴스

### 파일 위치

- **마이그레이션 스크립트**: `/docs/scripts/` 디렉토리에 생성
- **기존 마이그레이션**: `/supabase/migrations/`
- **테스트 스크립트**: `/__tests__/migrations/` (옵션)

## Change Log

| Date       | Version | Description                                                       | Author    |
| :--------- | :------ | :---------------------------------------------------------------- | :-------- |
| 2025-10-02 | 1.0     | Initial story creation from 1.2C split                            | Bob (SM)  |
| 2025-10-10 | 1.1     | 마이그레이션/검증/단일/대량 스크립트 골격 추가 (docs/scripts/*) | Dev Agent |

## Dev Agent Record

### Agent Model Used

Codex CLI Dev Agent (OpenAI) – Node v20 / TS 5.3

### Debug Log References

- .ai/debug-log.md 2025-10-10 항목: 스크립트 골격 추가 기록
- docs/qa/reports/1.2E-dry-run-20251013.md: DRY-RUN 리포트(누락=0)
- docs/qa/snapshots/1.2E-execution-log-table.md: 실행 로그 테이블 스냅샷(제안)
- supabase/migrations/20251013_create_migration_run_logs.sql: 실행 로그 테이블 마이그레이션 추가

### Completion Notes List

- 누락 보정/검증/단일/대량 마이그레이션 스크립트 골격 추가(docs/scripts)
- 트리거 보강/로깅/테스트는 후속 Must-Fix로 분리 예정
- 2025-10-13: 드라이런 리포트 및 실행 로그 테이블 스냅샷 추가
- 2025-10-13: BFF 프로필 미존재 시 500 방지 폴백 구현(src/app/api/v1/bff/configurator/route.ts)

### File List

- docs/scripts/migrate-user-profiles.sql
- docs/scripts/check-user-profiles.sql
- docs/scripts/create-single-user-profile.sql
- docs/scripts/bulk-migrate-users.sql
- docs/qa/reports/1.2E-dry-run-20251013.md
- docs/qa/snapshots/1.2E-execution-log-table.md
- supabase/migrations/20251013_create_migration_run_logs.sql
- src/app/api/v1/bff/configurator/route.ts (modified)
- __tests__/api/v1/bff/configurator.test.ts (modified)

### Dev Checklist (Brownfield)

- [x] 스크립트 골격 추가 및 위치 명시(docs/scripts)
- [ ] 트리거 보강 설계서 초안(예외 경로 포함)
- [x] 실행 로그 설계(테이블/파일) 및 dry-run/실행 리포트 포맷
- [ ] 전수 검증 쿼리 및 테스트 사용자 E2E 시나리오 작성

## QA Results

게이트 결정: CONCERNS

요약

- 본 스토리의 핵심 산출물(마이그레이션/검증 스크립트, 트리거 개선)이 레포 내 미존재 상태입니다. 현재 Draft 단계로 보이며, AC1~AC7 대부분을 충족할 근거가 없습니다.
- Configurator 초기화 블로킹(1.2D) 및 BFF 종속성 이슈가 병존하여, 프로필 누락이 런타임에 미치는 영향(500/초기화 지연)을 야기할 가능성이 높습니다. 프로필 자동 생성/보정이 보장되어야 초기 렌더 차단이 줄어듭니다.

AC 검토 결과

- AC1 모든 auth.users ↔ user_profiles 매핑: FAIL – 전수 검증 미수행, 보정 스크립트 부재.
- AC2 누락 레코드 생성 스크립트: FAIL – `docs/scripts/migrate-user-profiles.sql` 미존재.
- AC3 handle_new_user() 트리거 전 케이스 동작: CONCERNS – 현 구현은 있으나 실패 케이스 보강/테스트 근거 없음.
- AC4 파라미터화·재사용성: FAIL – 관련 스크립트 부재.
- AC5 중복 방지 처리: CONCERNS – 예상 설계는 있으나 실제 구현 부재.
- AC6 실행 로그 기록: FAIL – 로깅/감사 근거 부재.
- AC7 테스트 사용자로 검증: FAIL – 검증 로그/테스트 미제공.

리스크 프로파일

- 프로필 누락으로 인한 BFF 500/초기화 차단(High×High)
- 트리거 예외(OAuth/소셜 로그인)로 신규 가입 시 재현 가능(Med×Med)
- 스크립트 미비로 회귀 시 즉시 보정 불가(Med×High)

테스트 설계(Given-When-Then)

- Given 기존/신규 사용자 케이스(이메일/소셜/OAuth 다양성) When 로그인/가입 Then user_profiles/user_settings 자동 생성 확인.
- Given auth.users 전수 스캔 When 마이그레이션 스크립트 실행(dry-run) Then 누락 수=0, 이미 존재 항목은 skip 처리.
- Given 마이그레이션 실행 When 로깅 활성화 Then 실행 로그/감사 테이블에 기록.
- Given BFF 호출 When 프로필 누락 사용자를 포함한 시나리오 Then 500 없음, 게스트 폴백/오류 메시지 일관.

트레이서빌리티

- AC1/AC2/AC4/AC5: 마이그레이션/검증/보정 스크립트 + dry-run 리포트
- AC3: 트리거 단위 테스트(소셜/OAuth/이메일/엣지)
- AC6: 실행 로그 파일/테이블 스냅샷
- AC7: 테스트 사용자 플로우 로그

권고사항(Must-Fix)

1. 스크립트 구현: `docs/scripts/`에 migrate/check/bulk/single-user 스크립트 추가(ON CONFLICT DO NOTHING, 파라미터화).
2. 트리거 보강: 소셜/OAuth 경로 포함 실패 케이스 보강, 예외시 보정 큐에 적재.
3. 로깅: 실행 로그 테이블(또는 파일) 표준화, dry-run/실행 리포트 산출.
4. 테스트: 전수 검증 쿼리 + 신규 가입 E2E(자동 생성 확인) + BFF 호출 시 500 방지 확인.
5. 운영 가이드: 재실행 가능/안전 복구 절차 문서화.

근거(Evidence)

- 레포 내 스크립트 미존재 확인, 트리거는 기본형만 존재, 검증/로그 산출물 부재.

결론(Gate)

- CONCERNS – 드라이런 리포트 및 실행 로그 테이블 스냅샷 추가로 증거 공백 일부 해소. 실실행 로그 및 트리거 테스트 녹색 필요.

---

### Re-Review (2025-10-10)

- 진행 업데이트
  - 마이그레이션 스크립트 템플릿 추가: `docs/scripts/migrate-user-profiles.sql` (드라이런/실행/감사 로그 틀)
  - 후속 스크립트 계획: check/bulk/single 유틸 스크립트 추가 예정
- 재평가
  - AC1, AC3~AC7은 여전히 근거 부족 → FAIL 유지
  - 다음 전환 조건: 드라이런 리포트(누락=0), 실행 로그 적재, 트리거 예외(OAuth) 단위/통합 테스트 녹색
- 게이트: FAIL 유지 (스크립트/테스트/로그 근거 채워지면 CONCERNS→PASS 단계적 상향)

### Re-Review (2025-10-13)

- 진행 업데이트
  - 드라이런 리포트 추가: `docs/qa/reports/1.2E-dry-run-20251013.md`
  - 실행 로그 테이블 스냅샷 제안 추가: `docs/qa/snapshots/1.2E-execution-log-table.md`
- 평가
  - AC2/AC4/AC5(스크립트/재사용/중복방지)는 서류/골격 관점에서 충족 근거 강화
  - AC6(실행 로그)와 AC3/AC7(트리거 테스트/검증)은 여전히 불충분
- 권고(Must-Fix)
  1) real-run 수행 후 `migration_run_logs` 적재 + 리포트 제출
  2) 트리거 단위/통합 테스트 작성(이메일/OAuth/소셜)
  3) BFF 500 방지 시나리오 통합 테스트 추가(프로필 누락 포함)
- 게이트: CONCERNS (향후 실실행/테스트 증거 확보 시 PASS 가능)
