# Story 2.1: 3D 컨피규레이터 기반 구조 구축 — Core

## Summary

플랫폼 사용자가 웹에서 3D 책상 컨피규레이터를 사용할 수 있도록 Three.js r169 기반 렌더링, 카메라 컨트롤, 재료/치수 변경, BFF 연동의 기반을 제공합니다.

## Status

- Story: Ready for Review
- Gate: CONCERNS (성능 실측 로그 대기)

## Acceptance Criteria (요약)

1) Three.js 기반 3D 씬/조명/카메라/기본 모델 초기화
2) 궤도 컨트롤(마우스/터치), 줌 지원
3) 재료(원목/MDF/스틸) 변경 시 실시간 머터리얼 반영
4) 가로/세로/높이 1cm 단위 조절 → 모델 반영
5) 성능 목표: 모바일 FPS ≥ 30, 초기 로딩 ≤ 3s
6) BFF `/api/v1/bff/configurator` 연동(옵션 조회/상태 관리)
7) 반응형 UI, 로딩/에러, 접근성(기본) 적용
8) 테스트(씬 초기화/재료/치수/성능/호환성)
9) 개발 도구/에셋 관리 설정

## Architecture Snap

- WebGL2 우선, WebGL1 폴백, pixelRatio 제한(≤ 2)
- OrbitControls: damping 활성화, 거리/각도 제한
- 조명: Directional + Ambient, 그림자 활성화(PCF)
- 성능 모니터링: FPS/프레임타임 콜백(상위로 전달)

## Test Strategy (요약)

- Unit/Component: Jest + Testing Library (jsdom)
- E2E: Playwright(Chromium/Firefox/WebKit)로 3D 상호작용/성능 표지 검증
- 성능: FPS ≥ 30, 초기화 ≤ 3s 확인(실측 로그 캡처)
- 명령: `npm test`, `npm run test:e2e`

## NFR 상태 (2025-10-13)

- 성능: CONCERNS — 모바일 실측(FPS ≥ 30, 초기화 ≤ 3s) 로그 대기
- 신뢰성: PASS — 초기화/해제 경로 정상, 에러 처리 검증
- 유지보수성: PASS — 타입/모듈화/테스트 체계 양호
- 보안: PASS — BFF 경유, 민감 데이터 미노출

## Open Items

- 실단말/브라우저 성능 실측 로그 캡처 및 보관
- 초기화 시간(≤ 3s) 측정값 확보
- 상호작용 중 콘솔 경고/에러 무발생 근거 확보

## Gate

- Gate 파일: `docs/qa/gates/2.1-3d-configurator-foundation.yml`

## References

- Appendix: `docs/stories/2.1/2.1.appendix.md`
- 구성 요소: `src/components/three/ThreeCanvas.tsx`, `src/app/configurator/components/ConfiguratorUI.tsx`
- 유틸: `src/lib/three/*`
- 테스트: `__tests__/components/three/ThreeCanvas.test.tsx`, `__tests__/e2e/configurator/`

## PO Checklist (2025-10-13)

- 문서 구조: Core/Appendix 분리 완료 (가독성/유지보수성 향상)
- 수용기준: 축약본에 핵심 요구사항 유지(AC 1–9)
- 테스트 전략: Unit/jsdom + E2E/Playwright 병행 명시
- 링크/참조: Gate/Appendix/테스트/코드 경로 연결 확인
- 보안/비밀: 비밀값/키 미노출, BFF 경유 확인

결론: Checklist PASS

## PO Validation

- 일관성: 핵심-세부 문서 분리, 중복 축소, 책임 경계 명확
- 실행성: 테스트/성능 검증 지침이 실행 가능 수준으로 축약
- 추적성: Gate 파일과 NFR 상태를 Core에서 직접 참조 가능

결론: Story Document VALIDATED

## QA Results

### Review Date: 2025-10-13
Reviewed By: Quinn (Test Architect)

Scope
- 3D 유틸: geometry/materials
- 3D 컴포넌트: ThreeCanvas (성능 콜백/초기화 경로)

Evidence (focused tests)
- PASS: `__tests__/lib/three/geometry.test.ts` (모든 케이스 통과)
- PASS: `__tests__/lib/three/materials.test.ts` (확장 소재 허용으로 기대치 갱신 후 통과)
- PASS: `__tests__/components/three/ThreeCanvas.test.tsx` (three 모듈 최소 목 + 캔버스 모킹으로 onSceneReady/성능 콜백 검증 통과)
 - PASS: 수동 실서버 콘솔 확인(2025-10-13) — 상호작용 중 콘솔 에러/경고 무발생
 - PASS: 실측 성능 로그(2025-10-13) — FPS 76, Frame 13.3ms, RAM 120MB

Findings
- jsdom 보완: `HTMLCanvasElement.getContext` 전역 오버라이드 적용 완료(최소 WebGL/2D 모킹) → 테스트 안정화.
- 재료 확장: 테스트 기대치 유연화(최소 포함 검증)로 라이브러리 확장과 정합성 확보.
 - 실서버 콘솔: 사용자 수동 확인 결과 무에러 상태 확인됨.

NFR Status
- 성능: CONCERNS — FPS 충족(FPS 76 / 13.3ms) 확인. 초기화 ≤ 3s 로그 미제공, RAM 120MB(목표 ≤ 100MB)로 최적화 필요.
- 신뢰성/유지보수/보안: PASS (현 범위 내)

Gate Decision
- 변경: PASS (팀 결정으로 리스크 수용 — FPS 충족/콘솔 무에러, 초기화 ≤3s 로그 미제공 및 RAM 120MB는 사후 개선)

Actions
- [High] jsdom 캔버스 오버라이드: `jest.polyfills.js`에서 `HTMLCanvasElement.prototype.getContext`를 존재 여부와 무관하게 최소 모킹으로 오버라이드
- [High] Materials 테스트 기대치 갱신: 확장 소재 반영(길이 고정 검사 제거 또는 최소 포함 검증)
- [High] 실측 로그: 초기화 ≤ 3s 로그 수집(기록 양식 포함) — FPS는 충족 확인
- [Med] ThreeCanvas 테스트: WebGL 폴백 UI 경로도 허용하도록 시나리오 분기
- [Med] 메모리 최적화: 런타임 RAM ≤ 100MB 달성 또는 근거/예외 문서화

Measurement Guide (요약)
- 측정항목: 초기화시간(ms), 평균 FPS(10s 이상), 에러/경고 0건
- 권장: 실단말 또는 Playwright 실행 시 console/tracing 캡처와 타임스탬프 기록
 
Status Update for QA
- 위 2건(캔버스 모킹/소재 테스트 기대치) 처리 완료 → 잔여 항목은 실측 로그 수집 및 폴백 경로 시나리오 검증.

## Dev Agent Record

### Agent Model Used
- James (dev) via Codex CLI

### Debug Log References
- 명령: `npm test -- __tests__/lib/three/materials.test.ts` → PASS
- 명령: `npm test -- __tests__/components/three/ThreeCanvas.test.tsx` → PASS

### Completion Notes
- jsdom 캔버스 폴리필을 전역 오버라이드로 강화하여 테스트 안정화
- 소재 확장(wood/mdf/steel + metal/glass/fabric)에 맞게 테스트 기대치를 유연화
- ThreeCanvas 유닛 테스트에서 실제 WebGL 의존 제거를 위해 three 모듈을 최소 목으로 대체

### File List
- modified: `jest.polyfills.js`
- modified: `__tests__/lib/three/materials.test.ts`
- modified: `__tests__/components/three/ThreeCanvas.test.tsx`

### Change Log
- 2025-10-13: QA 지적사항 반영 — 캔버스 모킹 강화 및 소재 테스트 갱신, ThreeCanvas 테스트 안정화
