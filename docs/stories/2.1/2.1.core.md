# Story 2.1: 3D 컨피규레이터 기반 구조 구축 — Core

## Summary

플랫폼 사용자가 웹에서 3D 책상 컨피규레이터를 사용할 수 있도록 Three.js r169 기반 렌더링, 카메라 컨트롤, 재료/치수 변경, BFF 연동의 기반을 제공합니다.

## Status

- Story: pass
- Gate: CONCERNS (성능 실측 로그 대기)

## Acceptance Criteria (요약)

1. Three.js 기반 3D 씬/조명/카메라/기본 모델 초기화
2. 궤도 컨트롤(마우스/터치), 줌 지원
3. 재료(원목/MDF/스틸) 변경 시 실시간 머터리얼 반영
4. 가로/세로/높이 1cm 단위 조절 → 모델 반영
5. 성능 목표: 모바일 FPS ≥ 30, 초기 로딩 ≤ 3s
6. BFF `/api/v1/bff/configurator` 연동(옵션 조회/상태 관리)
7. 반응형 UI, 로딩/에러, 접근성(기본) 적용
8. 테스트(씬 초기화/재료/치수/성능/호환성)
9. 개발 도구/에셋 관리 설정

## Architecture Snap

- WebGL2 우선, WebGL1 폴백, pixelRatio 제한(≤ 2)
- OrbitControls: damping 활성화, 거리/각도 제한
- 조명: Directional + Ambient, 그림자 활성화(PCF)
- 성능 모니터링: FPS/프레임타임 콜백(상위로 전달)

## Test Strategy (요약)

- Unit/Component: Jest + Testing Library (jsdom)
- E2E: Playwright(Chromium/Firefox/WebKit)로 3D 상호작용/성능 표지 검증
- 성능: FPS ≥ 30, 초기화 ≤ 3s 확인(실측 로그 캡처)
- 명령: `npm test`, `npm run test:e2e`

## NFR 상태 (2025-10-13)

- 성능: CONCERNS — 모바일 실측(FPS ≥ 30, 초기화 ≤ 3s) 로그 대기
- 신뢰성: PASS — 초기화/해제 경로 정상, 에러 처리 검증
- 유지보수성: PASS — 타입/모듈화/테스트 체계 양호
- 보안: PASS — BFF 경유, 민감 데이터 미노출

## Open Items

- 실단말/브라우저 성능 실측 로그 캡처 및 보관
- 초기화 시간(≤ 3s) 측정값 확보
- 상호작용 중 콘솔 경고/에러 무발생 근거 확보

## Gate

- Gate 파일: `docs/qa/gates/2.1-3d-configurator-foundation.yml`

## References

- Appendix: `docs/stories/2.1/2.1.appendix.md`
- 구성 요소: `src/components/three/ThreeCanvas.tsx`, `src/app/configurator/components/ConfiguratorUI.tsx`
- 유틸: `src/lib/three/*`
- 테스트: `__tests__/components/three/ThreeCanvas.test.tsx`, `__tests__/e2e/configurator/`

## PO Checklist (2025-10-13)

- 문서 구조: Core/Appendix 분리 완료 (가독성/유지보수성 향상)
- 수용기준: 축약본에 핵심 요구사항 유지(AC 1–9)
- 테스트 전략: Unit/jsdom + E2E/Playwright 병행 명시
- 링크/참조: Gate/Appendix/테스트/코드 경로 연결 확인
- 보안/비밀: 비밀값/키 미노출, BFF 경유 확인

결론: Checklist PASS

## PO Validation

- 일관성: 핵심-세부 문서 분리, 중복 축소, 책임 경계 명확
- 실행성: 테스트/성능 검증 지침이 실행 가능 수준으로 축약
- 추적성: Gate 파일과 NFR 상태를 Core에서 직접 참조 가능

결론: Story Document VALIDATED

## QA Results

### Review Date: 2025-10-13

Reviewed By: Quinn (Test Architect)

Scope

- 3D 유틸: geometry/materials
- 3D 컴포넌트: ThreeCanvas (성능 콜백/초기화 경로)

Evidence (focused tests)

- PASS: `__tests__/lib/three/geometry.test.ts` (모든 케이스 통과)
- PASS: `__tests__/lib/three/materials.test.ts` (확장 소재 허용으로 기대치 갱신 후 통과)
- PASS: `__tests__/components/three/ThreeCanvas.test.tsx` (three 모듈 최소 목 + 캔버스 모킹으로 onSceneReady/성능 콜백 검증 통과)
- PASS: 수동 실서버 콘솔 확인(2025-10-13) — 상호작용 중 콘솔 에러/경고 무발생
- PASS: 실측 성능 로그(2025-10-13) — FPS 76, Frame 13.3ms, RAM 120MB

Findings

- jsdom 보완: `HTMLCanvasElement.getContext` 전역 오버라이드 적용 완료(최소 WebGL/2D 모킹) → 테스트 안정화.
- 재료 확장: 테스트 기대치 유연화(최소 포함 검증)로 라이브러리 확장과 정합성 확보.
- 실서버 콘솔: 사용자 수동 확인 결과 무에러 상태 확인됨.

NFR Status

- 성능: CONCERNS — FPS 충족(FPS 76 / 13.3ms) 확인. 초기화 ≤ 3s 로그 미제공, RAM 120MB(목표 ≤ 100MB)로 최적화 필요.
- 신뢰성/유지보수/보안: PASS (현 범위 내)

Gate Decision

- 변경: PASS (팀 결정으로 리스크 수용 — FPS 충족/콘솔 무에러, 초기화 ≤3s 로그 미제공 및 RAM 120MB는 사후 개선)

Actions

- [High] jsdom 캔버스 오버라이드: `jest.polyfills.js`에서 `HTMLCanvasElement.prototype.getContext`를 존재 여부와 무관하게 최소 모킹으로 오버라이드
- [High] Materials 테스트 기대치 갱신: 확장 소재 반영(길이 고정 검사 제거 또는 최소 포함 검증)
- [High] 실측 로그: 초기화 ≤ 3s 로그 수집(기록 양식 포함) — FPS는 충족 확인
- [Med] ThreeCanvas 테스트: WebGL 폴백 UI 경로도 허용하도록 시나리오 분기
- [Med] 메모리 최적화: 런타임 RAM ≤ 100MB 달성 또는 근거/예외 문서화

Measurement Guide (요약)

- 측정항목: 초기화시간(ms), 평균 FPS(10s 이상), 에러/경고 0건
- 권장: 실단말 또는 Playwright 실행 시 console/tracing 캡처와 타임스탬프 기록

Status Update for QA

- 위 2건(캔버스 모킹/소재 테스트 기대치) 처리 완료 → 잔여 항목은 실측 로그 수집 및 폴백 경로 시나리오 검증.

### QA Validation: 2025-10-15 (Mock 인증 경로)

Reviewed By: Quinn (Test Architect)

Scope

- 인증 미들웨어 `src/lib/auth-middleware.ts` Mock 토큰 처리
- API 인증 유틸 `src/lib/api/auth.ts` Mock 토큰 처리
- BFF `/api/v1/bff/configurator` 초기 호출(인증 경과 확인)

Evidence

- 수동 시나리오(Dev(Mock))
  1. 로그인(Mock 계정) → 성공 및 쿠키 설정 확인
  2. 상단 "3D 컨피규레이터" 이동 → `/configurator` 접근 시 재로그인 리다이렉트 없음
  3. 초기 로딩 중 BFF 호출 성공(401 미발생) 및 UI 정상 노출 확인

Decision

- Gate: PASS (Dev(Mock) 경로 한정 이슈 해결 확인)
- Notes: 프로덕션 실 Supabase 경로는 기존 로직 유지. Mock 분기 추가로 회귀 리스크 낮음.

### QA Results Update: 2025-10-15

Reviewed By: Quinn (Test Architect)

- 현상: 로그인 직후 `/configurator` 접속 시 재로그인 요구(리다이렉트 또는 BFF 401).
- 영향: Dev(Mock) 환경에서 컨피규레이터 진입 차단. 프로덕션(실 Supabase)에서는 비재현 예상.
- 근본 원인: Mock 토큰(`mock-token-*`)을 미들웨어/API 인증 유틸이 Supabase 실제 토큰으로 검증하여 항상 실패.
  - 참고: `src/lib/auth-middleware.ts`(보호 경로/토큰 검증), `src/lib/api/auth.ts`(토큰 검증), `src/lib/utils/mock-auth.ts`(토큰 발급), `/api/v1/bff/configurator`(인증 요구)
- 권고 조치: Dev(Mock) 분기에서 `mock-token-*`을 `mockGetUser`로 검증하거나, 최소한 Dev(Mock)에서 `/configurator` 보호 제외(권장도 낮음). 전자는 BFF 포함 전체 인증 경로 일관성 유지에 유리.
- 게이트 영향: Dev(Mock) 환경 한정 CONCERNS로 기록(아카이브 게이트 추가), 메인 게이트(PASS)는 프로덕션 전제 유지 가능. 추후 Mock 분기 패치 후 재평가.

### QA Results Update: 2025-10-20 — 인증/접근 정책 디버깅 요청 반영

Reviewed By: Quinn (Test Architect)

요청 사항 요약

- 현상: 로그인 직후 `/configurator` 접근 시 재로그인 요청이 다시 발생(리다이렉트 루프/401).
- 요구: 컨피규레이터 접근 정책을 “로그인 없이도 모두 접속 가능(퍼블릭)”으로 전환.

재현/관측

- Given: 사용자가 로그인(또는 방금 로그아웃) 상태에서 `/configurator` 경로로 이동
- When: 미들웨어가 경로 접근을 평가
- Then: 현재 설정상 `/configurator`는 보호 경로로 분류되어 비인증 시 `/login?redirect=/configurator`로 리다이렉트 → 로그인 직후 토큰 인식/전파 타이밍에 따라 재로그인 요청이 재발하거나, BFF 호출이 401로 실패하는 루프 발생 가능

원인 분석(코드 근거)

- `src/lib/auth-middleware.ts:11` — `PROTECTED_ROUTES`에 `'/configurator'` 포함(로그인 필수)
- `src/middleware.ts:5` — 전역 미들웨어에서 authMiddleware 적용, 기본 `redirectTo: '/login'`
- `src/app/api/v1/bff/configurator/route.ts` — BFF는 `authenticateRequest` 실패 시 401(비인증 접근 불가)

접근 정책 현황

- 현재: `/configurator`는 “로그인 필요(Protected)” 경로이며, BFF도 인증 필요. UI는 API 실패 시 기본 재료로 폴백하지만, 미들웨어에서 먼저 리다이렉트되므로 화면 진입 자체가 제한됨.

권고 조치(모두 접속 전환, 안전가드 포함)

1. 라우팅/미들웨어
   - `src/lib/auth-middleware.ts`에서 `PROTECTED_ROUTES`에서 `'/configurator'` 제거(또는 화이트리스트 방식으로 허용)
   - 필요 시 `authMiddleware`에 allowUnauthenticated 옵션을 경로 기반으로 분기(권장: 보호 경로 정의 축소)
2. BFF(`/api/v1/bff/configurator`)
   - 인증 선택적 허용: 비로그인 시 사용자 의존 데이터는 제외하고 공용 옵션(materials/pricing_rules의 공개 가능한 범위)만 반환
   - 응답에 `auth: { isAuthenticated: false }` 등 컨텍스트 명시(클라이언트 분기 용이)
3. UI(ConfiguratorUI)
   - 비로그인 시에도 접근/상호작용 가능(장바구니/구매는 로그인 유도)
   - 현 구현상 API 실패 시 기본 재료로 폴백하는 경로 유지(이미 구현됨)

검증 계획(제안)

- E2E(3브라우저):
  1. 비로그인 상태에서 `/configurator` 접근 → 페이지 렌더 PASS(리다이렉트 없음), 기본 재료 노출
  2. 로그인 상태에서 `/configurator` 접근 → 사용자 컨텍스트 반영 + BFF 200
  3. 비로그인→로그인 전환 후 재접속 시 리다이렉트 루프 없음 확인
  4. 장바구니/구매 플로우 클릭 시 로그인 유도 토스트/모달 확인

게이트 영향(제안)

- 접근 정책 퍼블릭 전환 + BFF 선택적 인증 허용 후 회귀 테스트 통과 시, 본 항목 관련 게이트 이슈 해제 가능.

Dev 태스크 제안(참고)

- [High] `PROTECTED_ROUTES`에서 `'/configurator'` 제거 및 경로 테스트 추가
- [High] BFF 라우트 인증 선택적 허용 및 비로그인 응답 스키마 정의/테스트
- [Med] `/middleware.ts`에서 예외 경로 주석/문서화

## Dev Agent Record

### Agent Model Used

- James (dev) via Codex CLI

### Debug Log References

- 명령: `npm test -- __tests__/lib/three/materials.test.ts` → PASS
- 명령: `npm test -- __tests__/components/three/ThreeCanvas.test.tsx` → PASS

### Completion Notes

- jsdom 캔버스 폴리필을 전역 오버라이드로 강화하여 테스트 안정화
- 소재 확장(wood/mdf/steel + metal/glass/fabric)에 맞게 테스트 기대치를 유연화
- ThreeCanvas 유닛 테스트에서 실제 WebGL 의존 제거를 위해 three 모듈을 최소 목으로 대체

### File List

- modified: `jest.polyfills.js`
- modified: `__tests__/lib/three/materials.test.ts`
- modified: `__tests__/components/three/ThreeCanvas.test.tsx`
- modified: `src/lib/auth-middleware.ts` — `/configurator` 퍼블릭 전환(QA Fix)
- modified: `src/app/api/v1/bff/configurator/route.ts` — 인증 선택적 허용(비로그인 퍼블릭 응답)

### Change Log

- 2025-10-13: QA 지적사항 반영 — 캔버스 모킹 강화 및 소재 테스트 갱신, ThreeCanvas 테스트 안정화
- 2025-10-20: QA Fix — 컨피규레이터 퍼블릭 접근 전환 및 BFF 선택적 인증 허용(비로그인 응답 지원)

### 2025-10-15 — Dev Update (Mock 인증 분기 보강)

- 변경 파일
  - modified: `src/lib/auth-middleware.ts` — `isMockMode()` + `mock-token-*` 토큰 시 `mockGetUser`로 검증 분기 추가
  - modified: `src/lib/api/auth.ts` — `extractUserFromToken`에 Mock 토큰 인증 경로 추가(세션 생성 포함)
- 목적
  - Dev(Mock) 환경에서 로그인 후 `/configurator` 접근 시 재로그인 루프 방지(BFF 및 보호 경로에서 인증 성공)
- 검증(개발 환경 수동)
  - 로그인(Mock) → 상단 네비 "3D 컨피규레이터" → 초기 로딩 중 BFF 200 응답 확인(재로그인 리다이렉트 미발생)
- 회귀 영향
  - 프로덕션 실 Supabase 경로는 기존 로직 유지(조건부 분기로 격리)
- 스토리 상태
  - 변경 범위 Green 유지. Ready for Review 전환은 전체 테스트 실행 후 확정 예정.
